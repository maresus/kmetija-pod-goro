<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kmetija Pod Goro ‚Äì Rezervacije</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand: #7b5e3b;
      --bg: #f5f4f1;
      --card: #fff;
      --muted: #7a7a7a;
      --border: #e6e2da;
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #1b1f1a;
      line-height: 1.6;
      padding-bottom: 32px;
    }
    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }
    .title { font-size: 1.3rem; font-weight: 700; display: flex; gap: 10px; align-items: center; }
    .subtitle { color: var(--muted); font-size: 0.95rem; }
    .chip { background: #f2ede6; color: #5b4327; padding: 6px 10px; border-radius: 999px; font-weight: 600; }
    .btn {
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      transition: transform 0.05s ease, box-shadow 0.2s ease;
      background: var(--brand);
      color: #fff;
      box-shadow: 0 8px 20px rgba(123,94,59,0.25);
    }
    .btn.large { padding: 12px 18px; font-size: 14px; }
    .btn.secondary { background: #f1ede5; color: #4b3a28; box-shadow: none; }
    .btn:hover { transform: translateY(-1px); }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat {
      background: var(--card);
      padding: 14px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      gap: 6px;
    }
    .stat .label { color: var(--muted); font-size: 0.9rem; }
    .stat .value { font-size: 1.8rem; font-weight: 700; color: var(--brand); }
    .stat .hint { color: var(--muted); font-size: 0.85rem; }
    .list-card { margin-bottom: 16px; }
    .list-card ol { padding-left: 18px; display: grid; gap: 6px; }
    .list-card li { font-size: 0.95rem; }
    .list-card .count { color: var(--muted); font-size: 0.85rem; }

    /* Filters */
    .filters {
      background: var(--card);
      padding: 14px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }
    .filter-row {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    select, input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Date grouping */
    .date-group { margin-bottom: 12px; border: 1px solid #e6e2da; border-radius: 10px; overflow: hidden; background: #fff; box-shadow: var(--shadow); }
    .date-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: #faf8f4; cursor: pointer; font-weight: 600; }
    .date-header:hover { background: #f5f2ec; }
    .date-count { color: #7a7a7a; font-weight: 400; }
    .date-toggle { margin-left: auto; transition: transform 0.2s; }
    .date-toggle.collapsed { transform: rotate(-90deg); }
    .date-reservations { padding: 8px; }
    .date-reservations.hidden { display: none; }
    .reservation-row {
      display: grid;
      grid-template-columns: 60px 110px 150px 80px 200px 120px 1fr 120px 140px;
      gap: 8px;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #f0ede8;
    }
    .reservation-row:last-child { border-bottom: none; }
    .reservation-row:hover { background: #f9f7f2; }
    .reservation-row.continuation { background: #faf9f7; border-left: 3px solid #e0dcd5; }
    .reservation-row.continuation:hover { background: #f5f3f0; }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-pending { background: #fff4d6; color: #8a6500; }
    .status-confirmed { background: #d7f2dd; color: #226536; }
    .status-rejected { background: #fbe0e0; color: #9a1f1f; }
    .status-processing { background: #e3ecff; color: #2f54a3; }
    .type-room { color: #50351e; }
    .type-table { color: #134f2b; }
    .muted { color: var(--muted); font-size: 12px; }
    .tooltip { max-width: 240px; }
    .btn-inline {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 700;
      font-size: 18px;
      line-height: 1.2;
      color: #4b3a28;
    }
    .btn-inline.danger { color: #b3261e; border-color: #f3c7c2; }
    .btn-inline.success { color: #1f7a3c; border-color: #b7e3c6; }
    .res-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .month-picker { display:flex; gap:10px; align-items:center; margin: 10px 0; flex-wrap: wrap; }
    .month-picker select, .month-picker input { width: auto; }
    .inline-actions { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0; }
    .overview-grid {
      display: grid;
      grid-template-columns: 1.4fr 0.6fr;
      gap: 16px;
      align-items: start;
      margin-top: 12px;
    }
    .sidebar-sticky {
      position: sticky;
      top: 12px;
      max-height: calc(100vh - 160px);
      overflow: auto;
    }
    .sidebar-compact {
      max-height: calc(100vh - 220px);
      font-size: 13px;
    }
    .sidebar-compact h4 {
      margin: 0 0 6px;
      font-size: 14px;
    }
    .sidebar-compact .day-item {
      padding: 8px;
      margin-bottom: 6px;
    }

    @media (max-width: 960px) {
      .reservation-row {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        font-size: 13px;
      }
      .overview-grid { grid-template-columns: 1fr; }
      .sidebar-sticky { position: static; max-height: none; }
      .modal-columns { grid-template-columns: 1fr; }
      .modal-col-right { position: static; max-height: none; }
    }

    /* Modal */
    .modal {
      position: fixed; inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      padding: 16px;
    }
    .modal.email-modal { z-index: 1200; }
    .modal.active { display: flex; }
    .modal-body {
      background: #fff;
      border-radius: 16px;
      max-width: 980px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      padding: 20px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 12px;
    }
    .modal-columns {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 16px;
    }
    .modal-col { display: grid; gap: 12px; }
    .modal-col-right {
      position: sticky;
      top: 10px;
      align-self: start;
      max-height: calc(90vh - 80px);
      overflow: auto;
    }
    .modal-title { font-size: 1.2rem; font-weight: 700; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
    .form-group { display: grid; gap: 6px; }
    label { font-weight: 600; font-size: 13px; color: #3b2d1e; }
    textarea { min-height: 90px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
    .sticky-actions {
      position: sticky;
      bottom: 0;
      background: #fff;
      padding: 10px 0 0;
      border-top: 1px solid #efe6d9;
    }
    .message-thread {
      background: #faf8f3;
      border: 1px solid #e6e2da;
      border-radius: 8px;
      padding: 10px;
      max-height: 340px;
      overflow-y: auto;
      font-size: 13px;
      color: #1f2937;
    }
    .message-thread .msg {
      border-bottom: 1px dashed #e6e2da;
      padding: 8px 0;
    }
    .message-thread .msg:last-child { border-bottom: 0; }
    .message-thread .meta {
      color: #7a7a7a;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .msg-refresh {
      margin-left: 8px;
      border: 1px solid #e6e2da;
      background: #fff;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .msg-badge {
      display: inline-block;
      min-width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #e54848;
      margin-left: 6px;
      vertical-align: middle;
    }

    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
    .tabs.equal .tab { flex: 1; text-align: center; }
    .tab {
      border: 1px solid var(--border);
      background: #fff;
      color: #4b3a28;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--shadow);
    }
    .tab.active { background: var(--brand); color: #fff; }
    .tab.small { padding: 6px 10px; font-size: 12px; }
    .vip-badge { background: #2f8f5b; color: #fff; border-radius: 999px; padding: 2px 6px; font-size: 11px; margin-left: 6px; }
    .group-badge { background: #c27d00; color: #fff; border-radius: 999px; padding: 2px 6px; font-size: 11px; margin-left: 6px; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      display: grid;
      gap: 8px;
      z-index: 2000;
      max-width: 320px;
    }
    .toast {
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      color: #1b1f1a;
      background: #fff;
      border-left: 4px solid var(--brand);
      animation: fade-in 0.2s ease;
      font-weight: 600;
    }
    .toast.success { border-color: #2f8f5b; }
    .toast.error { border-color: #c0392b; }
    .toast.warning { border-color: #c48c1c; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 960px) {
      table { min-width: 0; }
      th, td { font-size: 13px; }
      .table-wrap { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <div class="title">üè† Kmetija Pod Goro - Rezervacije</div>
        <div class="subtitle" id="current-date"></div>
      </div>
    </header>

    <div class="tabs" id="view-tabs">
      <button class="tab active" id="tab-view-res" onclick="setViewTab('reservations')">üìã Rezervacije</button>
      <button class="tab" id="tab-view-tools" onclick="setViewTab('tools')">üß∞ Orodja & analitika</button>
    </div>

    <div class="tabs equal">
      <button class="tab active" id="tab-room" onclick="setTab('room')">üõèÔ∏è Sobe</button>
      <button class="tab" id="tab-table" onclick="setTab('table')">üçΩÔ∏è Mize</button>
      <a class="tab" id="tab-inquiries" href="/admin/inquiries">üìù Povpra≈°evanja</a>
    </div>

    <div id="view-tools" style="display:none;">
      <div class="actions" style="margin-bottom:16px; flex-wrap:wrap;">
        <div id="imap-indicator" class="muted" style="font-size:12px; margin-right:6px;"></div>
        <button class="btn secondary" id="imapPreviewBtn" title="Prika≈æi zadnja sporoƒçila (subject)">
          üì¨ IMAP preview
        </button>
        <button class="btn secondary" id="imapResyncBtn" title="Roƒçno preberi zadnja sporoƒçila">
          üîÅ IMAP resync
        </button>
        <button class="btn secondary" id="unreadBtn" title="Novi odgovori">
          üîî Odgovori <span id="unreadCount" class="msg-badge" style="display:none; margin-left:6px;"></span>
        </button>
        <button class="btn secondary" onclick="exportCsv()">üì• Izvozi CSV</button>
        <button class="btn" onclick="loadAll()">üîÑ Osve≈æi podatke</button>
        <a class="btn secondary" href="/admin/conversations">üí¨ Pogovori</a>
        <a class="btn secondary" href="/admin/inquiries">üìù Povpra≈°evanja</a>
      </div>

      <div class="card list-card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="tab small active" id="tab-questions" onclick="setAnalyticsTab('questions')">Najpogostej≈°a vpra≈°anja</button>
            <button class="tab small" id="tab-lost" onclick="setAnalyticsTab('lost')">Lost intents</button>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn secondary" id="refreshQuestionsBtn">Osve≈æi</button>
            <button class="btn secondary" id="refreshLostBtn">Osve≈æi</button>
          </div>
        </div>
        <div id="questions-pane" style="margin-top:10px;">
          <div class="muted">Povzetek iz vseh pogovorov</div>
          <ol id="top-questions-list" style="margin-top:10px;"></ol>
        </div>
        <div id="lost-pane" style="margin-top:10px; display:none;">
          <div class="muted">Vpra≈°anja, kjer je bil potreben follow‚Äëup</div>
          <ol id="lost-intents-list" style="margin-top:10px;"></ol>
        </div>
      </div>

      <div class="card list-card">
        <div style="font-weight:700; margin-bottom:6px;">Rezervacijski funnel (zadnjih 30 dni)</div>
        <div class="muted" style="margin-bottom:10px;">Zaƒçetek ‚Üí dokonƒçana rezervacija</div>
        <div id="funnel-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px;"></div>
      </div>

      <div class="card list-card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div>
            <div style="font-weight:700;">Top 5 zgre≈°enih odgovorov</div>
            <div class="muted">Hitro izbolj≈°evanje baze znanja</div>
          </div>
          <button class="btn secondary" id="refreshMissedBtn">Osve≈æi</button>
        </div>
        <ol id="missed-questions-list" style="margin-top:10px;"></ol>
      </div>
    </div>

    <div id="view-reservations">
    <div class="stats" id="stats-cards">
      <div class="stat"><div class="label">Danes</div><div class="value" id="stat-danes">0</div><div class="hint">Rezervacije</div></div>
      <div class="stat"><div class="label">Ta teden</div><div class="value" id="stat-teden">0</div><div class="hint">Rezervacije</div></div>
      <div class="stat"><div class="label">Ta mesec</div><div class="value" id="stat-mesec">0</div><div class="hint">Rezervacije</div></div>
      <div class="stat"><div class="label">Potrjenih</div><div class="value" id="stat-confirmed">0</div></div>
      <div class="stat"><div class="label">ƒåaka</div><div class="value" id="stat-pending">0</div></div>
      <div class="stat"><div class="label">üõèÔ∏è Sobe</div><div class="value" id="stat-room">0</div></div>
      <div class="stat"><div class="label">üçΩÔ∏è Mize</div><div class="value" id="stat-table">0</div></div>
      <div class="stat"><div class="label">ü§ñ AI danes</div><div class="value" id="stat-ai-today">0</div></div>
      <div class="stat"><div class="label">ü§ñ AI ta mesec</div><div class="value" id="stat-ai-month">0</div></div>
      <div class="stat"><div class="label">ü§ñ AI letos</div><div class="value" id="stat-ai-year">0</div></div>
    </div>

  <div class="month-picker">
    <label for="month-select">Mesec:</label>
    <select id="month-select" onchange="selectMonth(this.value)">
      <option value="0">Januar</option>
      <option value="1">Februar</option>
      <option value="2">Marec</option>
      <option value="3">April</option>
      <option value="4">Maj</option>
      <option value="5">Junij</option>
      <option value="6">Julij</option>
      <option value="7">Avgust</option>
      <option value="8">September</option>
      <option value="9">Oktober</option>
      <option value="10">November</option>
      <option value="11">December</option>
    </select>
    <label for="year-input">Leto:</label>
    <input id="year-input" type="number" style="width:100px;" value="">
    <button class="btn secondary" onclick="applyMonthYear()">Nastavi</button>
    <button class="btn secondary" onclick="showTodayOverview()">Danes</button>
  </div>

  <div class="inline-actions">
    <button class="btn" onclick="openNewRoom()">+ Nova rezervacija sobe</button>
    <button class="btn secondary" onclick="openNewTable()">+ Nova rezervacija mize</button>
    <div id="imap-indicator-main" class="muted" style="font-size:12px; align-self:center;"></div>
  </div>

  <div id="pending-container" class="card" style="margin-top:12px;"></div>

  <div id="room-overview" class="overview-grid">
    <div id="room-calendar-block" class="card" style="margin-top: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <button class="btn secondary" onclick="changeMonth(-1)">‚óÄ Prej≈°nji</button>
        <h3 id="calendar-title" style="margin: 0;">Koledar (sobe)</h3>
        <button class="btn secondary" onclick="changeMonth(1)">Naslednji ‚ñ∂</button>
      </div>

      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; margin-bottom: 8px;">
        <div style="font-weight: 600; color: #7a7a7a;">PON</div>
        <div style="font-weight: 600; color: #7a7a7a;">TOR</div>
        <div style="font-weight: 600; color: #7a7a7a;">SRE</div>
        <div style="font-weight: 600; color: #7a7a7a;">ƒåET</div>
        <div style="font-weight: 600; color: #7a7a7a;">PET</div>
        <div style="font-weight: 600; color: #7a7a7a;">SOB</div>
        <div style="font-weight: 600; color: #7a7a7a;">NED</div>
      </div>

      <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
      </div>

      <div style="margin-top: 12px; display: flex; gap: 16px; flex-wrap: wrap;">
        <span style="font-weight:600;">Legenda:</span>
        <span style="color:#27ae60;">Potrjeno</span>
      <span style="color:#c27d00;">ƒåaka (tudi brez dodeljene sobe)</span>
        <span style="color:#e74c3c;">Dana≈°nji dan = rdeƒça obroba</span>
        <span style="color:#7a7a7a;">Prikazani so vsi zasedeni dnevi bivanja (check-in do noƒçi pred odhodom). Klik na dan poka≈æe podrobnosti.</span>
      </div>
    </div>

    <div id="day-sidebar" class="card sidebar-sticky sidebar-compact" style="display: none;">
      <h4 id="sidebar-date">Izberi dan</h4>
      <div id="sidebar-content"></div>
    </div>
  </div>

  <div id="table-overview" class="overview-grid" style="display: none;">
    <div id="table-calendar-block" class="card" style="margin-top: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <button class="btn secondary" onclick="changeMonth(-1)">‚óÄ Prej≈°nji</button>
        <h3 id="table-calendar-title" style="margin: 0;">Koledar (mize)</h3>
        <button class="btn secondary" onclick="changeMonth(1)">Naslednji ‚ñ∂</button>
      </div>
      <div id="table-calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;"></div>
      <div style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap; font-size: 13px;">
        <span>üíö <50% kapacitete</span>
        <span>üíõ 50-80%</span>
        <span>‚ù§Ô∏è >80%</span>
      </div>
    </div>

    <div id="table-sidebar" class="card sidebar-sticky sidebar-compact">
      <h4 id="table-sidebar-date">Izberi dan</h4>
      <div id="table-sidebar-content"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Vse rezervacije</h3>
    <div class="filters">
      <div class="filter-row">
        <select id="filter-status">
          <option value="">Vsi statusi</option>
          <option value="pending">ƒåaka</option>
          <option value="processing">V obdelavi</option>
          <option value="confirmed">Potrjeno</option>
          <option value="rejected">Zavrnjeno</option>
        </select>
        <select id="filter-type">
          <option value="">Vsi tipi</option>
          <option value="room">Sobe</option>
          <option value="table">Mize</option>
        </select>
        <select id="filter-source">
          <option value="">Vsi viri</option>
          <option value="chat">Chatbot</option>
          <option value="wordpress_room">WP Sobe</option>
          <option value="wordpress_table">WP Mize</option>
        </select>
        <input type="date" id="filter-date-from" />
        <input type="date" id="filter-date-to" />
      </div>
      <div class="actions">
        <button class="btn" onclick="loadAll()">Filtriraj</button>
        <button class="btn secondary" onclick="resetFilters()">Ponastavi</button>
        <div class="inline-actions" style="gap:6px;">
          <span style="color:#7a7a7a;">Hitra obdobja:</span>
          <button class="btn secondary" type="button" onclick="setRangeDays(14)">14 dni</button>
          <button class="btn secondary" type="button" onclick="setRangeDays(30)">30 dni</button>
          <button class="btn secondary" type="button" onclick="setRangeDays(90)">90 dni</button>
        </div>
        <label style="display:inline-flex; align-items:center; gap:6px; color:#7a7a7a;">
          <input type="checkbox" id="auto-refresh-toggle" onclick="toggleAutoRefresh(this.checked)" />
          Auto osve≈æi (30s)
        </label>
      </div>
    </div>
    <div id="reservations-container"></div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <!-- Email modal -->
  <div class="modal email-modal" id="email-modal">
    <div class="modal-body">
      <div class="modal-title">‚úâ Po≈°lji sporoƒçilo <span id="email-modal-name"></span></div>
      <form id="email-form">
        <input type="hidden" id="email-res-id">
        <div class="form-group">
          <label>Prejemnik</label>
          <input type="email" id="email-recipient" readonly>
        </div>
        <div class="form-group">
          <label>Zadeva</label>
          <input type="text" id="email-subject" value="Povpra≈°evanje - Kmetija Pod Goro">
        </div>
        <div class="form-group">
          <label>Predloga</label>
          <select id="email-template">
            <option value="">-- Izberi predlogo --</option>
            <option value="info">Prosimo za dodatne informacije</option>
            <option value="date">Potrditev datuma</option>
            <option value="full">≈Ωal zasedeno - alternativni termin</option>
            <option value="custom">Po meri</option>
          </select>
        </div>
        <div class="form-group">
          <label>Sporoƒçilo</label>
          <textarea id="email-body" placeholder="Vpi≈°ite va≈°e sporoƒçilo..."></textarea>
        </div>
        <div class="modal-actions">
      <button type="button" class="btn secondary" onclick="closeEmailModal()">Prekliƒçi</button>
      <button type="submit" class="btn">Po≈°lji</button>
    </div>
  </form>
    </div>
  </div>

  <!-- Modal soba -->
  <div class="modal" id="edit-room-modal">
    <div class="modal-body">
      <div class="modal-title">üõèÔ∏è Uredi rezervacijo sobe #<span id="room-edit-id"></span></div>
      <div class="muted" id="room-edit-flags" style="margin-top:-6px; margin-bottom:10px;"></div>
      <form id="room-edit-form">
        <input type="hidden" id="room-edit-hidden-id">
        <div class="modal-columns">
          <div class="modal-col">
            <div class="form-grid">
              <div class="form-group">
                <label>Status</label>
                <select id="room-edit-status">
                  <option value="pending">ƒåaka</option>
                  <option value="processing">V obdelavi</option>
                  <option value="confirmed">Potrjeno</option>
                  <option value="rejected">Zavrnjeno</option>
                </select>
              </div>
              <div class="form-group">
                <label>Datum prihoda</label>
                <input type="date" id="room-edit-date" required>
              </div>
              <div class="form-group">
                <label>≈†tevilo noƒçitev</label>
                <input type="number" id="room-edit-nights" min="1" required>
              </div>
              <div class="form-group">
                <label>Soba</label>
                <select id="room-edit-location">
                  <option value="">Nedoloƒçeno (dodeli ob potrditvi)</option>
                  <option value="ALJAZ">ALJA≈Ω</option>
                  <option value="JULIJA">JULIJA</option>
                  <option value="ANA">ANA</option>
                </select>
              </div>
              <div class="form-group">
                <label>≈†tevilo oseb</label>
                <input type="number" id="room-edit-people" min="1" required>
              </div>
              <div class="form-group">
                <label>≈†tevilo otrok</label>
                <input type="number" id="room-edit-kids" min="0">
              </div>
              <div class="form-group">
                <label>Starost otrok</label>
                <input type="text" id="room-edit-kids-ages" placeholder="npr. 8 in 6 let">
              </div>
              <div class="form-group">
                <label>Ime in priimek</label>
                <input type="text" id="room-edit-name" required>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="room-edit-email" required>
              </div>
              <div class="form-group">
                <label>Telefon</label>
                <input type="tel" id="room-edit-phone">
              </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
              <label>Opombe gosta</label>
              <textarea id="room-edit-note" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Admin opombe (interno)</label>
              <textarea id="room-edit-admin-notes" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-col modal-col-right">
            <div class="form-group">
              <label>
                Komunikacija
                <button type="button" class="msg-refresh" onclick="refreshMessages('room')">‚ü≥ Osve≈æi</button>
              </label>
              <div id="room-edit-comms" class="message-thread">Ni sporoƒçil.</div>
            </div>
          </div>
        </div>
        <div class="modal-actions sticky-actions">
          <button type="button" class="btn large" onclick="openEmailModalFromCurrent('room')">‚úâ Odgovori</button>
          <button type="button" class="btn secondary" onclick="closeRoomEditModal()">Prekliƒçi</button>
          <button type="submit" class="btn">üíæ Shrani</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal miza -->
  <div class="modal" id="edit-table-modal">
    <div class="modal-body">
      <div class="modal-title">üçΩÔ∏è Uredi rezervacijo mize #<span id="table-edit-id"></span></div>
      <div class="muted" id="table-edit-flags" style="margin-top:-6px; margin-bottom:10px;"></div>
      <form id="table-edit-form">
        <input type="hidden" id="table-edit-hidden-id">
        <div class="modal-columns">
          <div class="modal-col">
            <div class="form-grid">
              <div class="form-group">
                <label>Status</label>
                <select id="table-edit-status">
                  <option value="pending">ƒåaka</option>
                  <option value="processing">V obdelavi</option>
                  <option value="confirmed">Potrjeno</option>
                  <option value="rejected">Zavrnjeno</option>
                </select>
              </div>
              <div class="form-group">
                <label>Datum</label>
                <input type="date" id="table-edit-date" required>
              </div>
              <div class="form-group">
                <label>ƒåas prihoda</label>
                <input type="time" id="table-edit-time" required>
              </div>
              <div class="form-group">
                <label>Jedilnica</label>
                <select id="table-edit-location">
                  <option value="Pri peƒçi">Pri peƒçi (kapaciteta 15 oseb)</option>
                  <option value="Pri vrtu">Pri vrtu (kapaciteta 35 oseb)</option>
                </select>
              </div>
              <div class="form-group">
                <label>≈†tevilo oseb</label>
                <input type="number" id="table-edit-people" min="1" required>
              </div>
              <div class="form-group">
                <label>≈†tevilo otrok</label>
                <input type="number" id="table-edit-kids" min="0">
              </div>
              <div class="form-group">
                <label>Starost otrok</label>
                <input type="text" id="table-edit-kids-ages" placeholder="npr. 5 in 3 let">
              </div>
              <div class="form-group">
                <label>Tip dogodka</label>
                <select id="table-edit-event-type">
                  <option value="">-</option>
                  <option value="Kosilo">Kosilo</option>
                  <option value="Veƒçerja">Veƒçerja</option>
                  <option value="Praznovanje">Praznovanje</option>
                  <option value="Poslovno">Poslovno kosilo/veƒçerja</option>
                </select>
              </div>
              <div class="form-group">
                <label>Ime in priimek</label>
                <input type="text" id="table-edit-name" required>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="table-edit-email" required>
              </div>
              <div class="form-group">
                <label>Telefon</label>
                <input type="tel" id="table-edit-phone">
              </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
              <label>Posebne potrebe (alergije, visoki stolƒçki...)</label>
              <textarea id="table-edit-special-needs" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Admin opombe (interno)</label>
              <textarea id="table-edit-admin-notes" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-col modal-col-right">
            <div class="form-group">
              <label>
                Komunikacija
                <button type="button" class="msg-refresh" onclick="refreshMessages('table')">‚ü≥ Osve≈æi</button>
              </label>
              <div id="table-edit-comms" class="message-thread">Ni sporoƒçil.</div>
            </div>
          </div>
        </div>
        <div class="modal-actions sticky-actions">
          <button type="button" class="btn large" onclick="openEmailModalFromCurrent('table')">‚úâ Odgovori</button>
          <button type="button" class="btn secondary" onclick="closeTableEditModal()">Prekliƒçi</button>
          <button type="submit" class="btn">üíæ Shrani</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="confirm-modal">
    <div class="modal-body">
      <div class="modal-title" id="confirm-title">Potrdi rezervacijo</div>
      <form id="confirm-form">
        <input type="hidden" id="confirm-id" />
        <input type="hidden" id="confirm-type" />
        <div class="form-group">
          <label id="confirm-label">Izberi sobo</label>
          <div id="confirm-hint" style="color:#7a7a7a; font-size:13px; margin-bottom:4px;"></div>
          <select id="confirm-choice"></select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" onclick="closeConfirmModal()">Prekliƒçi</button>
          <button type="submit" class="btn">Potrdi in po≈°lji email</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="kb-fix-modal">
    <div class="modal-body">
      <div class="modal-title">üõ†Ô∏è Popravi v bazi znanja</div>
      <form id="kb-fix-form">
        <div class="form-group">
          <label>Vpra≈°anje</label>
          <input type="text" id="kb-fix-question" readonly>
        </div>
        <div class="form-group">
          <label>Predlagan popravek / odgovor</label>
          <textarea id="kb-fix-suggestion" rows="4" placeholder="Vnesi izbolj≈°an odgovor ali pravilno informacijo..." required></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" onclick="closeKbFixModal()">Prekliƒçi</button>
          <button type="submit" class="btn">Shrani predlog</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Nova soba -->
  <div class="modal" id="new-room-modal">
    <div class="modal-body">
      <div class="modal-title">+ Nova rezervacija sobe</div>
      <form id="new-room-form">
        <div class="form-grid">
          <div class="form-group">
            <label>Datum prihoda</label>
            <input type="date" id="new-room-date" required>
          </div>
          <div class="form-group">
            <label>Noƒçitve</label>
            <input type="number" id="new-room-nights" min="1" required>
          </div>
          <div class="form-group">
            <label>Soba</label>
            <select id="new-room-location">
              <option value="">Nedoloƒçeno</option>
              <option value="ALJAZ">ALJA≈Ω</option>
              <option value="JULIJA">JULIJA</option>
              <option value="ANA">ANA</option>
            </select>
          </div>
          <div class="form-group">
            <label>Osebe</label>
            <input type="number" id="new-room-people" min="1" required>
          </div>
          <div class="form-group">
            <label>Otroci</label>
            <input type="number" id="new-room-kids" min="0">
          </div>
          <div class="form-group">
            <label>Starost otrok</label>
            <input type="text" id="new-room-kids-ages">
          </div>
          <div class="form-group">
            <label>Ime in priimek</label>
            <input type="text" id="new-room-name" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="new-room-email" required>
          </div>
          <div class="form-group">
            <label>Telefon</label>
            <input type="tel" id="new-room-phone">
          </div>
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>Opombe</label>
          <textarea id="new-room-note"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" onclick="closeNewRoom()">Prekliƒçi</button>
          <button type="submit" class="btn">üíæ Shrani</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Nova miza -->
  <div class="modal" id="new-table-modal">
    <div class="modal-body">
      <div class="modal-title">+ Nova rezervacija mize</div>
      <form id="new-table-form">
        <div class="form-grid">
          <div class="form-group">
            <label>Datum</label>
            <input type="date" id="new-table-date" required>
          </div>
          <div class="form-group">
            <label>ƒåas</label>
            <input type="time" id="new-table-time" required>
          </div>
          <div class="form-group">
            <label>Jedilnica</label>
            <select id="new-table-location">
              <option value="Pri peƒçi">Pri peƒçi (15 oseb)</option>
              <option value="Pri vrtu">Pri vrtu (35 oseb)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Osebe</label>
            <input type="number" id="new-table-people" min="1" required>
          </div>
          <div class="form-group">
            <label>Otroci</label>
            <input type="number" id="new-table-kids" min="0">
          </div>
          <div class="form-group">
            <label>Starost otrok</label>
            <input type="text" id="new-table-kids-ages">
          </div>
          <div class="form-group">
            <label>Tip dogodka</label>
            <select id="new-table-event-type">
              <option value="">-</option>
              <option value="Kosilo">Kosilo</option>
              <option value="Veƒçerja">Veƒçerja</option>
              <option value="Praznovanje">Praznovanje</option>
              <option value="Poslovno">Poslovno kosilo/veƒçerja</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ime in priimek</label>
            <input type="text" id="new-table-name" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="new-table-email" required>
          </div>
          <div class="form-group">
            <label>Telefon</label>
            <input type="tel" id="new-table-phone">
          </div>
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>Posebne potrebe</label>
          <textarea id="new-table-special-needs"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" onclick="closeNewTable()">Prekliƒçi</button>
          <button type="submit" class="btn">üíæ Shrani</button>
        </div>
      </form>
    </div>
  </div>

  </div>

  <script>
    const API_BASE = '/api/admin';
    let currentTab = 'room';
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth(); // 0-indexed
    const TABLE_CAP = { 'Pri peƒçi': 15, 'Pri vrtu': 35 };

    function todayISO() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    const qs = id => document.getElementById(id);
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('sl-SI', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });

    document.addEventListener('DOMContentLoaded', () => {
      setViewTab('reservations');
      setTab('room', true);
      setInterval(loadStats, 60000);
      qs('month-select').value = calendarMonth.toString();
      qs('year-input').value = calendarYear.toString();
      const refreshQuestionsBtn = qs('refreshQuestionsBtn');
      if (refreshQuestionsBtn) {
        refreshQuestionsBtn.addEventListener('click', loadQuestionStats);
      }
      const refreshLostBtn = qs('refreshLostBtn');
      if (refreshLostBtn) {
        refreshLostBtn.addEventListener('click', loadLostIntents);
      }
      const refreshMissedBtn = qs('refreshMissedBtn');
      if (refreshMissedBtn) {
        refreshMissedBtn.addEventListener('click', loadMissedQuestions);
      }
      loadAll(); // auto load ob prvem prikazu
    });

    function setTab(tab, silent = false) {
      currentTab = tab;
      qs('tab-room').classList.toggle('active', tab === 'room');
      qs('tab-table').classList.toggle('active', tab === 'table');
      qs('filter-type').value = tab;
      qs('room-overview').style.display = tab === 'room' ? '' : 'none';
      qs('table-overview').style.display = tab === 'table' ? '' : 'none';
      if (!silent) {
        loadAll();
      }
    }

    function setViewTab(tab) {
      const isRes = tab === 'reservations';
      qs('tab-view-res').classList.toggle('active', isRes);
      qs('tab-view-tools').classList.toggle('active', !isRes);
      qs('view-reservations').style.display = isRes ? '' : 'none';
      qs('view-tools').style.display = isRes ? 'none' : '';
    }

    function setAnalyticsTab(tab) {
      const isQuestions = tab === 'questions';
      qs('tab-questions').classList.toggle('active', isQuestions);
      qs('tab-lost').classList.toggle('active', !isQuestions);
      qs('questions-pane').style.display = isQuestions ? '' : 'none';
      qs('lost-pane').style.display = isQuestions ? 'none' : '';
    }

    function toast(message, type = 'info', duration = 4000) {
      const container = qs('toast-container');
      if (!container) return;
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 200);
      }, duration);
    }

    function escapeHtml(value) {
      const str = String(value ?? '');
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function loadAll() {
      const tasks = [
        loadStats(),
        loadUsageStats(),
        loadQuestionStats(),
        loadLostIntents(),
        loadFunnelStats(),
        loadMissedQuestions(),
        loadReservations(),
        loadImapStatus(),
      ];
      if (currentTab === 'room') {
        tasks.push(renderCalendar());
      } else {
        tasks.push(renderTableCalendar());
      }
      await Promise.all(tasks);
      setTimeout(() => {
        const active = document.activeElement;
        if (active && active.tagName === 'SELECT') active.blur();
      }, 0);
      if (currentTab === 'room' && !selectedRoomDayKey) {
        showDayDetails(todayKey(), {});
      }
      if (currentTab === 'table' && !selectedTableDayKey) {
        showTableDayDetails(todayKey(), {});
      }
    }

    function refreshSelectedDay() {
      if (currentTab === 'room' && selectedRoomDayKey) {
        showDayDetails(selectedRoomDayKey, {});
      }
      if (currentTab === 'table' && selectedTableDayKey) {
        showTableDayDetails(selectedTableDayKey, {});
      }
    }

    function showTodayOverview() {
      const key = todayKey();
      if (currentTab === 'room') {
        showDayDetails(key, {});
      } else {
        showTableDayDetails(key, {});
      }
    }

    const unreadBtn = qs('unreadBtn');
    if (unreadBtn) {
      unreadBtn.addEventListener('click', () => {
        const target = qs('pending-container');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    function resetFilters() {
      qs('filter-status').value = '';
      qs('filter-type').value = currentTab;
      qs('filter-source').value = '';
      qs('filter-date-from').value = '';
      qs('filter-date-to').value = '';
      loadAll();
    }

    function setRangeDays(days) {
      const start = todayISO();
      const endDate = new Date();
      endDate.setDate(endDate.getDate() + days);
      const end = `${endDate.getFullYear()}-${String(endDate.getMonth()+1).padStart(2,'0')}-${String(endDate.getDate()).padStart(2,'0')}`;
      qs('filter-date-from').value = start;
      qs('filter-date-to').value = end;
      loadAll();
    }

    function buildQuery() {
      const status = qs('filter-status').value;
      const type = qs('filter-type').value || currentTab;
      const source = qs('filter-source').value;
      const date_from = qs('filter-date-from').value.replace(/\s+/g, '');
      const date_to = qs('filter-date-to').value.replace(/\s+/g, '');
      const params = new URLSearchParams();
      params.set('limit', '200');
      if (status) params.set('status', status);
      if (type) params.set('type', type);
      if (source) params.set('source', source);
      if (date_from) params.set('date_from', date_from);
      if (date_to) params.set('date_to', date_to);
      return params.toString();
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/stats`);
        const data = await res.json();
        qs('stat-danes').textContent = data.danes ?? 0;
        qs('stat-teden').textContent = data.ta_teden ?? 0;
        qs('stat-mesec').textContent = data.ta_mesec ?? 0;
        qs('stat-confirmed').textContent = data.po_statusu?.confirmed ?? 0;
        qs('stat-pending').textContent = data.po_statusu?.pending ?? 0;
        qs('stat-room').textContent = data.po_tipu?.room ?? 0;
        qs('stat-table').textContent = data.po_tipu?.table ?? 0;
      } catch (e) {
        console.error('Stats error', e);
      }
    }

    async function loadImapStatus() {
      try {
        const res = await fetch(`${API_BASE}/imap_status`);
        if (!res.ok) return;
        const data = await res.json().catch(() => ({}));
        const last = data.last_poll_at ? `IMAP: ${data.last_poll_at}` : 'IMAP: -';
        const err = data.last_error ? ` ‚Ä¢ napaka: ${data.last_error}` : '';
        ['imap-indicator', 'imap-indicator-main'].forEach((id) => {
          const el = qs(id);
          if (el) el.textContent = `${last}${err}`;
        });
      } catch (e) {
        // ignore
      }
    }

    const imapPreviewBtn = qs('imapPreviewBtn');
    if (imapPreviewBtn) {
      imapPreviewBtn.addEventListener('click', async () => {
        imapPreviewBtn.disabled = true;
        toast('IMAP preview‚Ä¶', 'info', 1500);
        try {
          const res = await fetch(`${API_BASE}/imap_preview?limit=50`, { cache: 'no-store' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.ok === false) {
            toast(data.error || 'IMAP preview ni uspel.', 'error');
          } else {
            const rows = (data.messages || []).map(m => `‚Ä¢ [${m.folder || 'INBOX'}] ${m.subject || '-'} ‚Äî ${m.from || '-'} (${m.date || '-'})`);
            alert(rows.length ? rows.join('\n') : 'Ni sporoƒçil v inboxu.');
          }
        } catch (e) {
          toast('IMAP preview ni uspel.', 'error');
        } finally {
          imapPreviewBtn.disabled = false;
        }
      });
    }

    const imapResyncBtn = qs('imapResyncBtn');
    if (imapResyncBtn) {
      imapResyncBtn.addEventListener('click', async () => {
        imapResyncBtn.disabled = true;
        toast('IMAP resync‚Ä¶', 'info', 1500);
        try {
          const res = await fetch(`${API_BASE}/imap_resync?limit=200`, { method: 'POST', cache: 'no-store' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.ok === false) {
            toast(data.error || 'IMAP resync ni uspel.', 'error');
          } else {
            const processed = data.processed || 0;
            const matched = data.matched || 0;
            const scanned = data.scanned || 0;
            toast(`IMAP resync OK (najdeno: ${processed}, ujemanja: ${matched}, pregledano: ${scanned})`, 'success');
            if (data.sample_subjects && data.sample_subjects.length) {
              console.log('[IMAP preview subjects]', data.sample_subjects);
            }
            loadAll();
          }
        } catch (e) {
          toast('IMAP resync ni uspel.', 'error');
        } finally {
          imapResyncBtn.disabled = false;
        }
      });
    }

    async function loadUsageStats() {
      try {
        const res = await fetch(`${API_BASE}/usage_stats`);
        const data = await res.json();
        qs('stat-ai-today').textContent = data.today ?? 0;
        qs('stat-ai-month').textContent = data.month ?? 0;
        qs('stat-ai-year').textContent = data.year ?? 0;
      } catch (e) {
        console.error('Usage stats error', e);
      }
    }

    async function loadQuestionStats() {
      try {
        const res = await fetch(`${API_BASE}/question_stats?limit=10`);
        const data = await res.json();
        const list = data.questions || [];
        const target = qs('top-questions-list');
        if (!list.length) {
          target.innerHTML = '<li class="muted">Ni podatkov.</li>';
          return;
        }
        target.innerHTML = list.map(item => `
          <li>
            ${escapeHtml(item.user_message || '-')}
            <span class="count">(${item.count || 0})</span>
          </li>
        `).join('');
      } catch (e) {
        console.error('Question stats error', e);
      }
    }

    async function loadLostIntents() {
      try {
        const res = await fetch(`${API_BASE}/lost_intents?limit=10`);
        const data = await res.json();
        const list = data.items || [];
        const target = qs('lost-intents-list');
        if (!list.length) {
          target.innerHTML = '<li class="muted">Ni podatkov.</li>';
          return;
        }
        target.innerHTML = list.map(item => `
          <li>
            ${escapeHtml(item.user_message || '-')}
            <span class="count">(${item.count || 0})</span>
          </li>
        `).join('');
      } catch (e) {
        console.error('Lost intents error', e);
      }
    }

    async function loadFunnelStats() {
      try {
        const res = await fetch(`${API_BASE}/funnel_stats?days=30`);
        const data = await res.json();
        const target = qs('funnel-grid');
        if (!target) return;
        const rows = [
          { label: 'Seje skupaj', value: data.total_sessions ?? 0 },
          { label: 'Zaƒçete rezervacije', value: data.reservation_started ?? 0 },
          { label: 'Dokonƒçane rezervacije', value: data.reservation_completed ?? 0 },
          { label: 'Start rate', value: `${data.start_rate_pct ?? 0}%` },
          { label: 'Completion rate', value: `${data.completion_rate_pct ?? 0}%` },
        ];
        target.innerHTML = rows.map(row => `
          <div class="stat" style="min-height:70px;">
            <div class="label">${row.label}</div>
            <div class="value">${row.value}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Funnel stats error', e);
      }
    }

    async function loadMissedQuestions() {
      try {
        const res = await fetch(`${API_BASE}/missed_questions?limit=5`);
        const data = await res.json();
        const list = data.items || [];
        const target = qs('missed-questions-list');
        if (!list.length) {
          target.innerHTML = '<li class="muted">Ni podatkov.</li>';
          return;
        }
        target.innerHTML = list.map(item => `
          <li style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <span>${escapeHtml(item.user_message || '-')} <span class="count">(${item.count || 0})</span></span>
            <button class="btn-inline" onclick="openKbFixModal('${encodeURIComponent(item.user_message || '')}')">üõ†Ô∏è Popravi v bazi</button>
          </li>
        `).join('');
      } catch (e) {
        console.error('Missed questions error', e);
      }
    }

    let lastReservations = [];
    let currentRoomReservation = null;
    let currentTableReservation = null;

    function isRepeatGuest(r) {
      if (!r) return false;
      if (!r.email && !r.phone) return false;
      return (lastReservations || []).some(o => {
        if (!o || o.id === r.id) return false;
        if (o.status !== 'confirmed') return false;
        const sameEmail = r.email && o.email && String(o.email).toLowerCase() === String(r.email).toLowerCase();
        const samePhone = r.phone && o.phone && String(o.phone).replace(/\s+/g, '') === String(r.phone).replace(/\s+/g, '');
        return sameEmail || samePhone;
      });
    }

    function isLargeGroup(r) {
      const people = parseInt(r?.people || 0);
      return people >= 8;
    }

    function renderGuestBadges(r) {
      let badges = '';
      if (isRepeatGuest(r)) badges += '<span class="vip-badge">VIP</span>';
      if (isLargeGroup(r)) badges += '<span class="group-badge">Velika skupina</span>';
      return badges;
    }

    function buildConversationEntries(reservation, messages) {
      const entries = [];
      if (reservation?.created_at) {
        entries.push({ ts: reservation.created_at, label: 'Rezervacija ustvarjena', kind: 'event' });
      }
      if (reservation?.confirmed_at) {
        entries.push({ ts: reservation.confirmed_at, label: 'Rezervacija potrjena', kind: 'event' });
      }
      (messages || []).forEach(m => {
        entries.push({
          ts: m.created_at || '',
          direction: (m.direction || '').toLowerCase(),
          subject: m.subject || '',
          body: m.body || '',
          kind: 'message',
        });
      });
      return entries.sort((a, b) => String(b.ts).localeCompare(String(a.ts)));
    }

    async function loadReservations() {
      const query = buildQuery();
      try {
        const res = await fetch(`${API_BASE}/reservations?${query}`);
        const data = await res.json();
        lastReservations = data.reservations || [];
        renderPending(lastReservations);
        renderReservations(lastReservations);
        checkUnreadForReservations(lastReservations);
      } catch (e) {
        console.error('Load reservations error', e);
      }
    }

    let autoRefreshTimer = null;
    function toggleAutoRefresh(enabled) {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (enabled) {
        autoRefreshTimer = setInterval(loadAll, 30000);
      }
    }

    function renderPending(resList) {
      const container = qs('pending-container');
      if (!container) return;
      const pending = (resList || []).filter(r => r.status === 'pending' || r.status === 'processing');
      let html = `<h3 style="margin-bottom:8px;">ƒåakajoƒçe rezervacije</h3>`;
      if (!pending.length) {
        container.innerHTML = html + `<div style="padding:10px; border:1px solid #f1e4c7; background:#fffaf0; border-radius:10px;">Ni ƒçakajoƒçih rezervacij ‚úì</div>`;
        return;
      }
      html += `<div class="date-reservations" style="border:1px solid #f1e4c7; background:#fffaf0; border-radius:10px;">`;
      html += pending.map(r => {
        const dataStr = encodeURIComponent(JSON.stringify(r));
        return `
          <div class="reservation-row" style="grid-template-columns: 120px 150px 120px 100px 1fr 160px;">
            <span class="res-date">${r.date || '-'}</span>
            <span class="res-guest">${r.name || 'Gost'} ${renderGuestBadges(r)}</span>
            <span class="res-room">${r.reservation_type === 'table' ? 'Miza' : 'Soba'}</span>
            <span class="res-people">${r.people || '-'} oseb</span>
            <span class="res-room">${r.location || '-'}</span>
            <span class="res-actions">
              <button class="btn-inline success" onclick="openConfirm('${dataStr}')">‚úÖ Potrdi</button>
              <button class="btn-inline danger" onclick="rejectReservation(${r.id})">‚ùå</button>
              <button class="btn-inline" onclick="openEdit('${dataStr}')">‚úèÔ∏è</button>
              <button class="btn-inline" onclick="openEmailModal('${dataStr}')">‚úâ</button>
              <span class="msg-badge" data-msg-badge="${r.id}" style="display:none"></span>
            </span>
          </div>
        `;
      }).join('');
      html += `</div>`;
      container.innerHTML = html;
    }

    function renderReservations(list) {
      const container = qs('reservations-container');
      if (!container) return;
      const monthNames = ['Januar', 'Februar', 'Marec', 'April', 'Maj', 'Junij', 'Julij', 'Avgust', 'September', 'Oktober', 'November', 'December'];

      const expanded = expandReservations(list);
      const pendingList = expanded.filter(r => r.isMainDay && (r.status === 'pending' || r.status === 'processing'));

      // filtriraj po izbranem datumu (ƒçe sta vnesena), sicer po prikazanem mesecu
      const dfVal = qs('filter-date-from').value;
      const dtVal = qs('filter-date-to').value;
      const dateFrom = dfVal ? new Date(dfVal) : null;
      const dateTo = dtVal ? new Date(dtVal) : null;

      const filtered = expanded.filter(r => {
        const d = parseDDMMYYYY(r.date);
        if (!d) return false;
        if (dateFrom && d < dateFrom) return false;
        if (dateTo && d > dateTo) return false;
        // ƒçe ni range filtrov, filtriramo na trenutno izbran mesec/let
        if (!dateFrom && !dateTo) {
          return d.getMonth() === calendarMonth && d.getFullYear() === calendarYear;
        }
        return true;
      });

      const byDate = {};
      filtered.forEach(r => {
        const date = r.date || 'Brez datuma';
        if (!byDate[date]) byDate[date] = [];
        byDate[date].push(r);
      });

      let html = '';

      const datesWithReservations = Object.keys(byDate).sort((a, b) => {
        const da = parseDDMMYYYY(a);
        const db = parseDDMMYYYY(b);
        if (!da || !db) return a.localeCompare(b);
        return da - db;
      });

      const monthKeys = Array.from(new Set(datesWithReservations.map(d => {
        const dd = parseDDMMYYYY(d);
        return dd ? `${dd.getFullYear()}-${dd.getMonth()}` : 'unknown';
      })));
      const title = monthKeys.length === 1 && datesWithReservations.length
        ? (() => {
            const dd = parseDDMMYYYY(datesWithReservations[0]);
            return `${monthNames[dd.getMonth()]} ${dd.getFullYear()}`;
          })()
        : 'Rezervacije (filtrirano)';

      html += `<h3 style="margin:12px 0 8px;">${title}</h3>`;

      let lastMonthKey = null;
      datesWithReservations.forEach(dateStr => {
        const dateKey = dateStr.replace(/\./g, '-');
        const items = byDate[dateStr] || [];
        const isNear = isDateWithin14Days(dateStr);
        const sortedItems = [...items].sort((a,b) => (b.isMainDay === true ? 1 : 0) - (a.isMainDay === true ? 1 : 0));
        const d = parseDDMMYYYY(dateStr);
        const monthKey = d ? `${d.getFullYear()}-${d.getMonth()}` : 'unknown';
        if (monthKey !== lastMonthKey && monthKeys.length > 1) {
          html += `<h4 style="margin:10px 0 6px; color:#4b3a28;">${d ? monthNames[d.getMonth()] + ' ' + d.getFullYear() : 'Brez datuma'}</h4>`;
          lastMonthKey = monthKey;
        }
        html += `
          <div class="date-group">
            <div class="date-header" onclick="toggleGroup('${dateKey}')">
              <span>üìÖ</span>
              <span>${dateStr}</span>
              <span class="date-count">(${items.length} rezervacij${items.length === 1 ? 'a' : ''})</span>
              <span class="date-toggle ${isNear ? '' : 'collapsed'}" id="toggle-${dateKey}">${isNear ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            <div class="date-reservations ${isNear ? '' : 'hidden'}" id="group-${dateKey}">
              ${sortedItems.length ? sortedItems.map(r => renderReservationRow(r, false)).join('') : '<div style="padding:8px 4px;color:#7a7a7a;">Ni rezervacij.</div>'}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderStatus(status) {
      const cls = status ? `status-${status}` : '';
      const label = status === 'pending' ? 'ƒåaka' :
                    status === 'confirmed' ? 'Potrjeno' :
                    status === 'rejected' ? 'Zavrnjeno' :
                    status === 'processing' ? 'V obdelavi' : status || '-';
      return `<span class="badge ${cls}">${label}</span>`;
    }
    function renderStatusText(status) {
      if (status === 'pending') return 'ƒåaka';
      if (status === 'confirmed') return 'Potrjeno';
      if (status === 'rejected') return 'Zavrnjeno';
      if (status === 'processing') return 'V obdelavi';
      return status || '-';
    }

    function parseDDMMYYYY(val) {
      if (!val) return null;
      const parts = String(val).split('.');
      if (parts.length === 3) {
        const [d, m, y] = parts.map(Number);
        if (!isNaN(d) && !isNaN(m) && !isNaN(y)) {
          return new Date(y, m - 1, d);
        }
      }
      const asDate = new Date(val);
      return isNaN(asDate.getTime()) ? null : asDate;
    }

    function toggleGroup(dateKey) {
      const content = qs(`group-${dateKey}`);
      const toggle = qs(`toggle-${dateKey}`);
      if (!content || !toggle) return;
      const isHidden = content.classList.contains('hidden');
      content.classList.toggle('hidden', !isHidden);
      toggle.textContent = isHidden ? '‚ñº' : '‚ñ∂';
      toggle.classList.toggle('collapsed', !isHidden);
    }

    function expandReservations(list) {
      const expanded = [];
      list.forEach(r => {
        const start = parseDDMMYYYY(r.date);
        if (!start) return;
        if (r.reservation_type === 'room' && r.nights && r.nights > 1) {
          const total = parseInt(r.nights, 10) || 1;
          for (let i = 0; i < total; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i);
            const dateStr = formatDate(d);
            expanded.push({
              ...r,
              date: dateStr,
              isMainDay: i === 0,
              dayNumber: i + 1,
              totalDays: total,
              mainDate: formatDate(start),
              endDate: formatDate(new Date(start.getFullYear(), start.getMonth(), start.getDate() + total - 1)),
            });
          }
        } else {
          expanded.push({
            ...r,
            isMainDay: true,
            dayNumber: 1,
            totalDays: r.nights || 1,
            mainDate: formatDate(start),
            endDate: r.date,
          });
        }
      });
      return expanded;
    }

    function isDateWithin14Days(dateStr) {
      const parts = dateStr.split('.');
      if (parts.length !== 3) return false;
      const d = new Date(parts[2], parts[1] - 1, parts[0]);
      const now = new Date();
      const diff = (d - now) / (1000 * 60 * 60 * 24);
      return diff >= -1 && diff <= 14;
    }

    function formatDate(d) {
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }

    function todayKey() {
      const d = new Date();
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }

    let selectedRoomDayKey = '';
    let selectedTableDayKey = '';

    function extractDinner(note) {
      if (!note) return '';
      const match = String(note).match(/Veƒçerje?:\\s*([^\\n]+)/i);
      return match ? match[1].trim() : '';
    }

    function parseDDMMYYYY(value) {
      if (!value) return null;
      const parts = String(value).split('.');
      if (parts.length !== 3) return null;
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      const d = new Date(year, month, day);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function ddmmyyyyToIso(dateStr) {
      const d = parseDDMMYYYY(dateStr);
      if (!d) return '';
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function dateKeyToDate(dateKey) {
      return parseDDMMYYYY(dateKey);
    }

    function dayStatusLabel(dateKey, startDateStr, nights) {
      const start = parseDDMMYYYY(startDateStr);
      const day = dateKeyToDate(dateKey);
      if (!start || !day) return '';
      const nightsInt = parseInt(nights || 1, 10) || 1;
      const checkout = new Date(start);
      checkout.setDate(checkout.getDate() + nightsInt);
      const startKey = formatDate(start);
      const checkoutKey = formatDate(checkout);
      const dayKey = formatDate(day);
      if (dayKey === startKey) return 'Check-in';
      if (dayKey === checkoutKey) return 'Check-out';
      return 'Bivanje';
    }

    function renderSummary(targetId, r) {
      const el = qs(targetId);
      if (!el || !r) return;
      const dinner = extractDinner(r.note || '');
      const kids = r.kids ? `${r.kids}${r.kids_small ? ' (' + r.kids_small + ')' : ''}` : '-';
      const lines = [
        ['Status', r.status || '-'],
        ['Datum', r.date || '-'],
        ['Ura', r.time || '-'],
        ['Noƒçitve', r.nights || '-'],
        ['Osebe', r.people || '-'],
        ['Otroci', kids],
        ['Lokacija', r.location || '-'],
        ['Veƒçerja', dinner || '-'],
        ['Telefon', r.phone || '-'],
        ['Email', r.email || '-'],
        ['Vir', r.source || '-'],
        ['Ustvarjeno', r.created_at || '-'],
      ];
      const note = r.note || '';
      const adminNotes = r.admin_notes || '';
      const eventType = r.event_type || '';
      const specialNeeds = r.special_needs || '';
      const detailBlocks = [
        eventType ? ['Dogodek', eventType] : null,
        specialNeeds ? ['Posebne potrebe', specialNeeds] : null,
        note ? ['Opombe gosta', note] : null,
        adminNotes ? ['Admin opombe', adminNotes] : null,
      ].filter(Boolean);
      const summaryLines = lines.map(([label, value]) => `
        <div class="line" style="justify-content:space-between; gap:8px;">
          <span class="muted">${escapeHtml(label)}</span>
          <strong>${escapeHtml(String(value))}</strong>
        </div>
      `).join('');
      const detailLines = detailBlocks.map(([label, value]) => `
        <div style="margin-top:8px;">
          <div class="muted" style="font-weight:700; font-size:12px; margin-bottom:4px;">${escapeHtml(label)}</div>
          <div>${escapeHtml(String(value))}</div>
        </div>
      `).join('');
      el.innerHTML = summaryLines + detailLines;
    }

    function formatTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return String(ts);
      return d.toLocaleString('sl-SI', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    function renderReservationRow(r, showDate = false) {
      const kidsInfo = r.kids ? ` (${r.kids} otrok${r.kids_small ? ': ' + r.kids_small : ''})` : '';
      const roomDisplay = r.reservation_type === 'table'
        ? `${r.location || '-'} ${r.time ? 'ob ' + r.time : ''}`
        : (r.location && !String(r.location).toLowerCase().includes('dodelimo') ? r.location : '-');
      const nightsDisplay = r.reservation_type === 'table' ? '-' : (r.nights || '-');
      const guestName = r.name || 'Gost';
      const badges = renderGuestBadges(r);
      const peopleLabel = `${r.people || '-'} oseb${kidsInfo}`;
      const dateLabel = showDate ? (r.date || '-') : '';
      if (r.isMainDay) {
        return `
          <div class="reservation-row">
            <span class="res-id">#${r.id}</span>
            <span class="res-date">${dateLabel}</span>
            <span class="res-guest">${guestName} ${badges}</span>
            <span class="res-nights">${r.reservation_type === 'table' ? '-' : `${r.nights || 1} noƒçi${r.totalDays ? ` (${r.date} - ${r.endDate || ''})` : ''}`}</span>
            <span class="res-people">${peopleLabel}</span>
            <span class="res-room">${roomDisplay || '-'}</span>
            <span class="res-note">${r.note ? (r.note.length > 35 ? r.note.slice(0,35)+'‚Ä¶' : r.note) : '-'}</span>
            <span>${renderStatus(r.status)}</span>
            <span class="res-actions">
              <button class="btn-inline success" onclick="openConfirm('${encodeURIComponent(JSON.stringify(r))}')">‚úÖ</button>
              <button class="btn-inline danger" onclick="rejectReservation(${r.id})">‚ùå</button>
              <button class="btn-inline" onclick="openEdit('${encodeURIComponent(JSON.stringify(r))}')">‚úèÔ∏è</button>
              <button class="btn-inline" onclick="openEmailModal('${encodeURIComponent(JSON.stringify(r))}')">‚úâ</button>
              <span class="msg-badge" data-msg-badge="${r.id}" style="display:none"></span>
            </span>
          </div>
        `;
      }
      const continuationLabel = r.totalDays ? `‚Ü≥ ${guestName} (noƒç ${r.dayNumber}/${r.totalDays})` : `‚Ü≥ ${guestName}`;
      return `
        <div class="reservation-row continuation">
          <span class="res-id" style="opacity:0.4">#${r.id}</span>
          <span class="res-date">${dateLabel}</span>
          <span class="res-guest" style="opacity:0.6">${continuationLabel}</span>
          <span class="res-nights"></span>
          <span class="res-people"></span>
          <span class="res-room" style="opacity:0.6">${roomDisplay || '-'}</span>
          <span class="res-note"></span>
          <span class="badge status-${r.status}" style="opacity:0.5">${renderStatusText(r.status)}</span>
          <span class="res-actions">
            <span style="color:#999; font-size:11px; cursor:pointer;" onclick="scrollToDate('${r.mainDate || r.date}')">‚Üí glej ${r.mainDate || r.date}</span>
          </span>
        </div>
      `;
    }

    function openKbFixModal(question) {
      qs('kb-fix-question').value = decodeURIComponent(question || '');
      qs('kb-fix-suggestion').value = '';
      qs('kb-fix-modal').classList.add('active');
    }

    function closeKbFixModal() {
      qs('kb-fix-modal').classList.remove('active');
    }

    qs('kb-fix-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = qs('kb-fix-question').value.trim();
      const suggestion = qs('kb-fix-suggestion').value.trim();
      if (!question || !suggestion) {
        toast('Prosim vnesi predlog.', 'error');
        return;
      }
      const res = await fetch(`${API_BASE}/knowledge_feedback`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, suggestion }),
      });
      if (!res.ok) {
        toast('Predloga ni bilo mogoƒçe shraniti.', 'error');
        return;
      }
      toast('Predlog shranjen.', 'success');
      closeKbFixModal();
    });

    function isTableReservation(r) {
      if (!r) return false;
      const type = (r.reservation_type || '').toLowerCase();
      if (type === 'table' || type === 'miza') return true;
      const loc = (r.location || '').toLowerCase();
      if (loc.includes('pri peƒçi') || loc.includes('pri vrtu')) return true;
      if (r.time) return true;
      if (r.event_type) return true;
      return false;
    }

    function openConfirm(dataStr) {
      const r = JSON.parse(decodeURIComponent(dataStr));
      const isTable = isTableReservation(r);
      qs('confirm-id').value = r.id;
      qs('confirm-type').value = isTable ? 'table' : 'room';
      qs('confirm-title').textContent = `Potrdi rezervacijo #${r.id} (${r.name || 'gost'})`;
      const select = qs('confirm-choice');
      const hint = qs('confirm-hint');
      select.innerHTML = '';
      if (isTable) {
        qs('confirm-label').textContent = 'Izberi jedilnico';
        hint.textContent = r.location ? `Gost je izbral: ${r.location}` : 'Gost ni izbral jedilnice.';
        ['Pri peƒçi', 'Pri vrtu'].forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          select.appendChild(o);
        });
        if (r.location) select.value = r.location;
      } else {
        qs('confirm-label').textContent = 'Izberi sobo';
        hint.textContent = r.location ? `Gost je izbral: ${(r.location || '').toUpperCase()}` : 'Gost ni izbral sobe.';
        ['', 'ALJAZ', 'JULIJA', 'ANA'].forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt ? opt : '-- izberi --';
          select.appendChild(o);
        });
        const currentRoom = (r.location || '').toUpperCase();
        select.value = currentRoom && ['ALJAZ','JULIJA','ANA'].includes(currentRoom) ? currentRoom : '';
      }
      qs('confirm-modal').classList.add('active');
    }
    function closeConfirmModal() { qs('confirm-modal').classList.remove('active'); }

    function clearNewRoomForm() {
      const ids = [
        'new-room-date',
        'new-room-nights',
        'new-room-people',
        'new-room-kids',
        'new-room-kids-ages',
        'new-room-location',
        'new-room-name',
        'new-room-email',
        'new-room-phone',
        'new-room-note',
      ];
      ids.forEach(id => {
        const el = qs(id);
        if (el) el.value = '';
      });
    }

    function clearNewTableForm() {
      qs('new-table-date').value = '';
      qs('new-table-time').value = '';
      qs('new-table-location').value = 'Pri peƒçi';
      qs('new-table-people').value = '';
      qs('new-table-kids').value = '';
      qs('new-table-kids-ages').value = '';
      qs('new-table-event-type').value = '';
      qs('new-table-name').value = '';
      qs('new-table-email').value = '';
      qs('new-table-phone').value = '';
      qs('new-table-special-needs').value = '';
    }

    // Email modal
    function openEmailModal(dataStr) {
      const r = typeof dataStr === 'string' ? JSON.parse(decodeURIComponent(dataStr)) : dataStr;
      qs('email-modal-name').textContent = r?.name ? `(${r.name})` : '';
      qs('email-res-id').value = r?.id || '';
      qs('email-recipient').value = r?.email || '';
      const tag = r?.id ? `Rezervacija #${r.id}` : 'Rezervacija';
      qs('email-subject').value = `${tag} - Dodatne informacije`;
      qs('email-body').value = '';
      qs('email-template').value = '';
      qs('email-modal').classList.add('active');
    }
    function openEmailModalFromCurrent(type) {
      const res = type === 'room' ? currentRoomReservation : currentTableReservation;
      if (!res) {
        toast('Najprej izberi rezervacijo.', 'warning');
        return;
      }
      openEmailModal(encodeURIComponent(JSON.stringify(res)));
    }
    function closeEmailModal() { qs('email-modal').classList.remove('active'); }
    const emailTpl = qs('email-template');
    if (emailTpl) {
      emailTpl.addEventListener('change', (e) => {
        const tpl = e.target.value;
        const body = qs('email-body');
        if (!body) return;
        if (tpl === 'info') body.value = 'Prosimo vas za dodatne informacije (termin, ≈°tevilo oseb, posebnosti), da lahko pripravimo ponudbo.';
        else if (tpl === 'date') body.value = 'Prosimo potrdite datum/uro, da dokonƒçno potrdimo rezervacijo.';
        else if (tpl === 'full') body.value = 'Izbrani termin je zaseden. Lahko ponudimo alternativni termin?';
        else body.value = '';
      });
    }
    const emailForm = qs('email-form');
    if (emailForm) {
      emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          reservation_id: qs('email-res-id').value,
          email: qs('email-recipient').value,
          subject: qs('email-subject').value,
          body: qs('email-body').value,
          set_processing: false,
        };
        try {
          const res = await fetch(`${API_BASE}/send-message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            toast(data.detail || 'Napaka pri po≈°iljanju emaila.', 'error');
            return;
          }
          toast('Email poslan ‚úì', 'success');
          closeEmailModal();
          if (qs('edit-room-modal')?.classList.contains('active')) {
            refreshMessages('room');
          } else if (qs('edit-table-modal')?.classList.contains('active')) {
            refreshMessages('table');
          }
        } catch (err) {
          toast('Napaka pri po≈°iljanju emaila.', 'error');
        }
      });
    }

    function openNewRoom() {
      clearNewRoomForm();
      qs('new-room-modal').classList.add('active');
    }
    function closeNewRoom() { qs('new-room-modal').classList.remove('active'); }
    function openNewTable() {
      clearNewTableForm();
      qs('new-table-modal').classList.add('active');
    }
    function closeNewTable() { qs('new-table-modal').classList.remove('active'); }

    function formatToDDMMYYYY(dateStr) {
      if (!dateStr) return '';
      const parts = String(dateStr).split('-');
      if (parts.length === 3) {
        return `${parts[2].padStart(2,'0')}.${parts[1].padStart(2,'0')}.${parts[0]}`;
      }
      return dateStr;
    }

    async function confirmReservation(id, payload) {
      const res = await fetch(`${API_BASE}/reservations/${id}/confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {}),
      });
      const data = await res.json();
      if (!res.ok) {
        toast(data.detail || 'Napaka pri potrditvi.', 'error');
        return;
      }
      if (data.warning) {
        toast(data.warning, 'warning');
        return;
      }
      toast('Rezervacija potrjena.', 'success');
      closeConfirmModal();
      await loadAll();
      refreshSelectedDay();
    }

    qs('confirm-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = qs('confirm-id').value;
      const type = qs('confirm-type').value;
      const choice = qs('confirm-choice').value;
      if (!choice) {
        toast('Izberi mo≈ænost pred potrditvijo.', 'warning');
        return;
      }
      if (type === 'table') {
        confirmReservation(id, { location: choice });
      } else {
        confirmReservation(id, { room: choice });
      }
    });

    async function renderCalendar() {
      const title = qs('calendar-title');
      const grid = qs('calendar-grid');
      if (!title || !grid) return;
      const monthNames = ['Januar', 'Februar', 'Marec', 'April', 'Maj', 'Junij', 'Julij', 'Avgust', 'September', 'Oktober', 'November', 'December'];
      title.textContent = `${monthNames[calendarMonth]} ${calendarYear}`;

      let calendarData = {};
      try {
        const res = await fetch(`${API_BASE}/calendar/rooms?month=${calendarMonth + 1}&year=${calendarYear}`);
        const payload = await res.json();
        calendarData = payload.days || payload;
      } catch (e) {
        console.error('Calendar load error', e);
        grid.innerHTML = '<div style="grid-column: span 7; text-align:center; color:#9a8f84;">Napaka pri nalaganju koledarja.</div>';
        return;
      }

      grid.innerHTML = '';
      const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
      const startDay = firstDay === 0 ? 6 : firstDay - 1; // Monday-first
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();

      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        empty.style.cssText = 'min-height: 80px;';
        grid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = calendarData[dateKey] || { confirmed: [], pending: [], reservations: [] };
        const hasConfirmed = (dayData.confirmed || []).length > 0;
        const hasPending = (dayData.pending || []).length > 0;
        let bg = '#fff';
        if (hasConfirmed && hasPending) bg = '#fdf6e3';
        else if (hasConfirmed) bg = '#f2fbf4';
        else if (hasPending) bg = '#fff8e6';

        // stage (check-in / mid / checkout)
        let hasCheckin = false;
        let hasMid = false;
        let hasLast = false;
        (dayData.reservations || []).forEach(r => {
          const start = parseDDMMYYYY(r.date);
          const n = parseInt(r.nights || '1', 10) || 1;
          if (!start || n <= 0) return;
          const current = new Date(dateKey);
          const last = new Date(start);
          last.setDate(start.getDate() + n - 1);
          if (current.getTime() === start.getTime()) hasCheckin = true;
          else if (current.getTime() === last.getTime()) hasLast = true;
          else if (current > start && current < last) hasMid = true;
        });

        const cell = document.createElement('div');
        const isToday = dateKey === todayISO();
        const outline = isToday ? '2px solid #e74c3c' : (hasLast ? '2px dashed #8e8e8e' : '1px solid #e6e2da');
        const effectiveBg = hasMid ? '#fef9f2' : bg;
        cell.style.cssText = `min-height: 80px; border: ${outline}; border-radius: 8px; padding: 6px; cursor: pointer; background: ${effectiveBg};`;
        cell.onmouseover = () => cell.style.background = '#f9f7f2';
        cell.onmouseout = () => cell.style.background = effectiveBg;
        cell.onclick = () => showDayDetails(dateKey, dayData);

        const dayNum = document.createElement('div');
        dayNum.style.cssText = 'font-weight: 600; margin-bottom: 4px;';
        dayNum.textContent = day;
        cell.appendChild(dayNum);

        const rooms = document.createElement('div');
        rooms.style.cssText = 'font-size: 12px; line-height: 1.4;';
        const normalizeRoomLabel = (name) => name === 'ND' ? 'Nedodeljeno' : name;
        const confirmedList = Array.from(new Set(dayData.confirmed || [])).map(normalizeRoomLabel);
        const pendingList = Array.from(new Set(dayData.pending || [])).map(normalizeRoomLabel);
        if (confirmedList.length) {
          rooms.innerHTML += `<div style="color:#2e7d32; font-weight:600;">Potrjeno: ${confirmedList.join(', ')}</div>`;
        }
        if (pendingList.length) {
          rooms.innerHTML += `<div style="color:#c27d00; font-weight:600;">ƒåaka: ${pendingList.join(', ')}</div>`;
          // quick actions za pending
        const pendingActions = (dayData.reservations || []).filter(
          r => r.status === 'pending' && ddmmyyyyToIso(r.date) === dateKey
        );
          if (pendingActions.length) {
            rooms.innerHTML += pendingActions.map(r => {
              const dataStr = encodeURIComponent(JSON.stringify(r));
              return `<div style="margin-top:4px;">
                <button class="btn-inline success" onclick="openConfirm('${dataStr}')">‚úÖ ${r.name || 'Gost'}</button>
                <button class="btn-inline danger" onclick="rejectReservation(${r.id})">‚ùå</button>
              </div>`;
            }).join('');
          }
        }
        if ((dayData.reservations || []).length) {
          const tooltip = (dayData.reservations || [])
            .map(r => {
              const contact = [r.email, r.phone].filter(Boolean).join(' | ');
              return `${r.name || 'Gost'} ¬∑ ${r.people || '-'} oseb${r.kids ? ' (' + r.kids + ')' : ''}${r.location ? ' ¬∑ ' + r.location : ''}${contact ? ' ¬∑ ' + contact : ''}`;
            })
            .join('\\n');
          cell.title = tooltip;
        }
        cell.appendChild(rooms);
        grid.appendChild(cell);
      }
    }

    async function renderTableCalendar() {
      const grid = qs('table-calendar-grid');
      const title = qs('table-calendar-title');
      if (!grid || !title) return;
      const monthNames = ['Januar', 'Februar', 'Marec', 'April', 'Maj', 'Junij', 'Julij', 'Avgust', 'September', 'Oktober', 'November', 'December'];
      title.textContent = `${monthNames[calendarMonth]} ${calendarYear}`;
      let data = {};
      try {
        const res = await fetch(`${API_BASE}/calendar/tables?month=${calendarMonth + 1}&year=${calendarYear}`);
        data = await res.json();
      } catch (e) {
        grid.innerHTML = '<div style="grid-column: span 7; text-align:center; color:#9a8f84;">Napaka pri nalaganju koledarja miz.</div>';
        return;
      }
      grid.innerHTML = '';
      const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
      const startDay = firstDay === 0 ? 6 : firstDay - 1;
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        empty.style.cssText = 'min-height: 80px;';
        grid.appendChild(empty);
      }
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = data[dateKey] || { total_people: 0, capacity: 50, reservations: [] };
        const reservations = dayData.reservations || [];
        const pece = reservations.filter(r => (r.location || '').toLowerCase().includes('pe')).reduce((s,r)=>s+(r.people||0),0);
        const vrtu = reservations.filter(r => (r.location || '').toLowerCase().includes('vrt')).reduce((s,r)=>s+(r.people||0),0);
        const percentPece = TABLE_CAP['Pri peƒçi'] ? (pece / TABLE_CAP['Pri peƒçi']) * 100 : 0;
        const percentVrtu = TABLE_CAP['Pri vrtu'] ? (vrtu / TABLE_CAP['Pri vrtu']) * 100 : 0;
        const worst = Math.max(percentPece, percentVrtu);
        const percent = worst;
        let bg = '#e9f7ef'; // green-ish
        if (percent >= 80) bg = '#fdecea';
        else if (percent >= 50) bg = '#fff4d6';

        const cell = document.createElement('div');
        const isToday = dateKey === todayISO();
        const outline = isToday ? '2px solid #e74c3c' : '1px solid #e6e2da';
        cell.style.cssText = `min-height: 80px; border: ${outline}; border-radius: 8px; padding: 6px; cursor: pointer; background: ${bg};`;
        cell.onmouseover = () => cell.style.outline = '1px solid #c9b99f';
        cell.onmouseout = () => cell.style.outline = 'none';
        cell.onclick = () => showTableDayDetails(dateKey, dayData);

        const dayNum = document.createElement('div');
        dayNum.style.cssText = 'font-weight: 600; margin-bottom: 4px;';
        dayNum.textContent = day;
        cell.appendChild(dayNum);

        const info = document.createElement('div');
        info.style.cssText = 'font-size: 12px; color: #4b3a28; display:grid; gap:2px;';
        info.innerHTML = `
          <span>Pri peƒçi: ${pece}/${TABLE_CAP['Pri peƒçi']}</span>
          <span>Pri vrtu: ${vrtu}/${TABLE_CAP['Pri vrtu']}</span>
        `;
        cell.appendChild(info);
        const pendingActions = reservations.filter(r => r.status === 'pending');
        if (pendingActions.length) {
          cell.innerHTML += pendingActions.map(r => {
            const dataStr = encodeURIComponent(JSON.stringify(r));
            return `<div style="margin-top:4px;">
              <button class="btn-inline success" onclick="openConfirm('${dataStr}')">‚úÖ ${r.name || 'Gost'}</button>
              <button class="btn-inline danger" onclick="rejectReservation(${r.id || ''})">‚ùå</button>
            </div>`;
          }).join('');
        }
        if (reservations.length) {
          const tooltip = reservations
            .map(r => {
              const contact = [r.email, r.phone].filter(Boolean).join(' | ');
              return `${r.time || '-'} ¬∑ ${r.name || 'Gost'} ¬∑ ${r.people || 0} oseb${r.location ? ' ¬∑ ' + r.location : ''}${contact ? ' ¬∑ ' + contact : ''}`;
            })
            .join('\\n');
          cell.title = tooltip;
        }

        grid.appendChild(cell);
      }
    }

    function changeMonth(delta) {
      calendarMonth += delta;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear -= 1;
      } else if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear += 1;
      }
      renderCalendar();
      renderTableCalendar();
      renderReservations(lastReservations || []);
      qs('month-select').value = calendarMonth.toString();
      qs('year-input').value = calendarYear.toString();
    }

    function selectMonth(val) {
      calendarMonth = parseInt(val, 10) || 0;
      renderCalendar();
      renderTableCalendar();
      renderReservations(lastReservations || []);
    }

    function applyMonthYear() {
      const m = parseInt(qs('month-select').value, 10) || 0;
      const y = parseInt(qs('year-input').value, 10) || calendarYear;
      calendarMonth = Math.min(11, Math.max(0, m));
      calendarYear = y;
      renderCalendar();
      renderTableCalendar();
      renderReservations(lastReservations || []);
    }

    async function showDayDetails(dateKey, dayData) {
      const sidebar = qs('day-sidebar');
      const dateTitle = qs('sidebar-date');
      const content = qs('sidebar-content');
      if (!sidebar || !dateTitle || !content) return;
      sidebar.style.display = 'block';
      dateTitle.textContent = dateKey;
      selectedRoomDayKey = dateKey;
      try {
        const res = await fetch(`${API_BASE}/reservations?date_from=${dateKey}&date_to=${dateKey}&type=room&limit=50`);
        const data = await res.json();
        const reservations = data.reservations || [];
        if (!reservations.length) {
          content.innerHTML = '<p style="color: #7a7a7a;">Ni rezervacij za ta dan.</p>';
          return;
        }
        const sorted = reservations.sort((a,b) => (a.created_at || '').localeCompare(b.created_at || ''));
        content.innerHTML = sorted.map(r => `
          <div class="day-item" style="border: 1px solid #e6e2da; border-radius: 8px;">
            <div style="font-weight: 600;">${r.name || 'Gost'}</div>
            <div style="color: #7a7a7a; font-size: 13px;">
              ${r.people || '-'} oseb ${r.kids ? '(' + r.kids + ' otrok)' : ''}<br>
              ${r.location || 'Soba ni dodeljena'}<br>
              ${dayStatusLabel(dateKey, r.date, r.nights) ? dayStatusLabel(dateKey, r.date, r.nights) + '<br>' : ''}
              <span class="badge status-${r.status}">${r.status}</span><br>
              ${[r.email, r.phone].filter(Boolean).join(' | ')}
            </div>
            ${r.note ? `<div style="color:#7a7a7a;font-size:12px;margin-top:6px;"><strong>Opombe gosta:</strong> ${escapeHtml(r.note)}</div>` : ''}
            ${r.admin_notes ? `<div style="color:#7a7a7a;font-size:12px;margin-top:4px;"><strong>Admin:</strong> ${escapeHtml(r.admin_notes)}</div>` : ''}
            <div style="margin-top: 8px; display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn-inline" onclick="openEdit('${encodeURIComponent(JSON.stringify(r))}')">‚úèÔ∏è Uredi</button>
              ${r.status === 'pending' ? `
                <button class="btn-inline success" onclick="openConfirm('${encodeURIComponent(JSON.stringify(r))}')">‚úÖ Potrdi</button>
                <button class="btn-inline danger" onclick="rejectReservation(${r.id})">‚ùå Zavrni</button>
              ` : ''}
            </div>
          </div>
        `).join('');
      } catch (e) {
        content.innerHTML = '<p style="color: #c0392b;">Napaka pri nalaganju podatkov za ta dan.</p>';
      }
    }

    async function showTableDayDetails(dateKey, dayData) {
      const sidebar = qs('table-sidebar');
      const dateTitle = qs('table-sidebar-date');
      const content = qs('table-sidebar-content');
      if (!sidebar || !dateTitle || !content) return;
      sidebar.style.display = 'block';
      dateTitle.textContent = dateKey;
      selectedTableDayKey = dateKey;
      const reservations = dayData.reservations || [];
      if (!reservations.length) {
        content.innerHTML = '<p style="color:#7a7a7a;">Ni rezervacij za ta dan.</p>';
        return;
      }
      content.innerHTML = reservations
        .sort((a,b) => (a.time || '').localeCompare(b.time || ''))
        .map(r => `
          <div class="day-item" style="border: 1px solid #e6e2da; border-radius: 8px;">
            <div style="font-weight: 600;">${r.name || 'Gost'} (${r.people || 0} oseb)</div>
            <div style="color:#7a7a7a;font-size:13px;">${r.time || '-'} | ${r.location || ''} | ${r.status || ''}</div>
            <div style="color:#7a7a7a;font-size:13px;">${[r.email, r.phone].filter(Boolean).join(' | ')}</div>
            ${r.note ? `<div style="color:#7a7a7a;font-size:12px;margin-top:6px;"><strong>Opombe gosta:</strong> ${escapeHtml(r.note)}</div>` : ''}
            ${r.special_needs ? `<div style="color:#7a7a7a;font-size:12px;margin-top:4px;"><strong>Posebne potrebe:</strong> ${escapeHtml(r.special_needs)}</div>` : ''}
            ${r.admin_notes ? `<div style="color:#7a7a7a;font-size:12px;margin-top:4px;"><strong>Admin:</strong> ${escapeHtml(r.admin_notes)}</div>` : ''}
            <div style="margin-top: 8px; display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn-inline" onclick="openEdit('${encodeURIComponent(JSON.stringify(r))}')">‚úèÔ∏è Uredi</button>
              ${r.status === 'pending' ? `
                <button class="btn-inline success" onclick="openConfirm('${encodeURIComponent(JSON.stringify(r))}')">‚úÖ Potrdi</button>
                <button class="btn-inline danger" onclick="rejectReservation(${r.id})">‚ùå Zavrni</button>
              ` : ''}
            </div>
          </div>
        `).join('');
    }

    async function rejectReservation(id) {
      if (!confirm('Ali res ≈æelite zavrniti rezervacijo?')) return;
      const res = await fetch(`${API_BASE}/reservations/${id}/reject`, { method: 'POST' });
      if (!res.ok) {
        toast('Napaka pri zavrnitvi.', 'error');
        return;
      }
      toast('Rezervacija zavrnjena.', 'success');
      loadAll();
    }

    function openEdit(dataStr) {
      const r = JSON.parse(decodeURIComponent(dataStr));
      if (!r.id) {
        toast('Rezervacije ni mogoƒçe odpreti (manjka ID).', 'warning');
        return;
      }
      if (r.reservation_type === 'table') {
        openTableEditModal(r);
      } else {
        openRoomEditModal(r);
      }
    }

    const MSG_SEEN_KEY = 'reservation_msg_seen';
    function getSeenMap() {
      try { return JSON.parse(localStorage.getItem(MSG_SEEN_KEY) || '{}'); } catch (e) { return {}; }
    }
    function setSeenMap(map) {
      try { localStorage.setItem(MSG_SEEN_KEY, JSON.stringify(map)); } catch (e) {}
    }
    function updateBadge(resId, hasUnread) {
      document.querySelectorAll(`[data-msg-badge="${resId}"]`).forEach(el => {
        el.style.display = hasUnread ? 'inline-block' : 'none';
      });
    }
    function markSeen(resId, lastInbound) {
      if (!lastInbound) return;
      const map = getSeenMap();
      map[resId] = lastInbound;
      setSeenMap(map);
      updateBadge(resId, false);
    }

    async function loadReservationMessages(resId, targetId, markAsSeen = false, attempt = 1) {
      const container = qs(targetId);
      if (!container) return;
      container.textContent = 'Nalagam sporoƒçila...';
      try {
        const res = await fetch(`${API_BASE}/reservations/${resId}/messages`);
        if (!res.ok) {
          const errText = await res.text().catch(() => '');
          const statusMsg = `Napaka pri nalaganju sporoƒçil (${res.status}).`;
          container.textContent = errText ? `${statusMsg} ${errText.slice(0,120)}` : statusMsg;
          if (attempt === 1) {
            setTimeout(() => loadReservationMessages(resId, targetId, markAsSeen, 2), 1500);
          }
          return;
        }
        const data = await res.json().catch(() => ({}));
        const messages = data.messages || [];
        if (!messages.length) {
          container.textContent = 'Ni sporoƒçil.';
          return;
        }
        const inbound = messages.filter(m => (m.direction || '').toLowerCase() === 'inbound');
        const lastInbound = inbound.length ? inbound[inbound.length - 1].created_at : null;
        const reservation = targetId === 'room-edit-comms' ? currentRoomReservation : currentTableReservation;
        const entries = buildConversationEntries(reservation, messages);
        if (!entries.length) {
          container.textContent = 'Ni sporoƒçil.';
          return;
        }
        container.innerHTML = entries.map(e => {
          const isEvent = e.kind === 'event';
          const when = formatTimestamp(e.ts || '');
          const label = isEvent
            ? 'Sistem'
            : (e.direction === 'inbound' ? 'Gost' : (e.direction === 'outbound' ? 'Moj odgovor' : 'Sistem'));
          const title = isEvent ? (e.label || '') : (e.subject || '');
          const body = isEvent ? '' : (e.body || '');
          return `
          <div class="msg">
            <div class="meta">
              ${escapeHtml(label)}${when ? ' ‚Ä¢ ' + escapeHtml(when) : ''}
            </div>
            <div><strong>${escapeHtml(title)}</strong></div>
            ${body ? `<div>${escapeHtml(body)}</div>` : ''}
          </div>
        `;
        }).join('');
        if (markAsSeen && lastInbound) {
          markSeen(resId, lastInbound);
        }
      } catch (err) {
        container.textContent = 'Napaka pri nalaganju sporoƒçil (omre≈æna napaka).';
        if (attempt === 1) {
          setTimeout(() => loadReservationMessages(resId, targetId, markAsSeen, 2), 1500);
        }
      }
    }

    function refreshMessages(type) {
      const id = type === 'room' ? qs('room-edit-hidden-id').value : qs('table-edit-hidden-id').value;
      const target = type === 'room' ? 'room-edit-comms' : 'table-edit-comms';
      if (!id) return;
      loadReservationMessages(id, target, false);
    }

    async function checkUnreadForReservations(resList) {
      const candidates = (resList || []).filter(r => ['pending','processing'].includes(r.status));
      const seenMap = getSeenMap();
      let unreadCount = 0;
      for (const r of candidates) {
        try {
          const res = await fetch(`${API_BASE}/reservations/${r.id}/messages`);
          const data = await res.json().catch(() => ({}));
          const messages = data.messages || [];
          const inbound = messages.filter(m => (m.direction || '').toLowerCase() === 'inbound');
          const lastInbound = inbound.length ? inbound[inbound.length - 1].created_at : null;
          const lastSeen = seenMap[r.id];
          if (lastInbound && (!lastSeen || lastInbound > lastSeen)) {
            updateBadge(r.id, true);
            unreadCount += 1;
          } else {
            updateBadge(r.id, false);
          }
        } catch (e) {
          // ignore
        }
      }
      const countEl = qs('unreadCount');
      if (countEl) {
        if (unreadCount > 0) {
          countEl.style.display = 'inline-block';
          countEl.textContent = String(unreadCount);
          countEl.style.width = 'auto';
          countEl.style.height = 'auto';
          countEl.style.padding = '2px 6px';
        } else {
          countEl.style.display = 'none';
        }
      }
    }

    function openRoomEditModal(r) {
      currentRoomReservation = r;
      qs('room-edit-id').textContent = r.id;
      qs('room-edit-hidden-id').value = r.id;
      qs('room-edit-status').value = r.status || 'pending';
      qs('room-edit-date').value = parseDate(r.date);
      qs('room-edit-nights').value = r.nights || 1;
      qs('room-edit-location').value = normalizeRoom(r.location);
      qs('room-edit-people').value = r.people || 1;
      qs('room-edit-kids').value = r.kids || 0;
      qs('room-edit-kids-ages').value = r.kids_small || '';
      qs('room-edit-name').value = r.name || '';
      qs('room-edit-email').value = r.email || '';
      qs('room-edit-phone').value = r.phone || '';
      qs('room-edit-note').value = r.note || '';
      qs('room-edit-admin-notes').value = r.admin_notes || '';
      qs('room-edit-flags').innerHTML = renderGuestBadges(r) || '';
      loadReservationMessages(r.id, 'room-edit-comms', true);
      qs('edit-room-modal').classList.add('active');
      setTimeout(() => {
        const active = document.activeElement;
        if (active && active.tagName === 'SELECT') active.blur();
      }, 0);
    }
    function closeRoomEditModal() { qs('edit-room-modal').classList.remove('active'); }

    function openTableEditModal(r) {
      currentTableReservation = r;
      qs('table-edit-id').textContent = r.id;
      qs('table-edit-hidden-id').value = r.id;
      qs('table-edit-status').value = r.status || 'pending';
      qs('table-edit-date').value = parseDate(r.date);
      qs('table-edit-time').value = r.time || '12:00';
      qs('table-edit-location').value = normalizeTable(r.location);
      qs('table-edit-people').value = r.people || 1;
      qs('table-edit-kids').value = r.kids || 0;
      qs('table-edit-kids-ages').value = r.kids_small || '';
      qs('table-edit-event-type').value = r.event_type || '';
      qs('table-edit-name').value = r.name || '';
      qs('table-edit-email').value = r.email || '';
      qs('table-edit-phone').value = r.phone || '';
      qs('table-edit-special-needs').value = r.special_needs || '';
      qs('table-edit-admin-notes').value = r.admin_notes || '';
      qs('table-edit-flags').innerHTML = renderGuestBadges(r) || '';
      loadReservationMessages(r.id, 'table-edit-comms', true);
      qs('edit-table-modal').classList.add('active');
      setTimeout(() => {
        const active = document.activeElement;
        if (active && active.tagName === 'SELECT') active.blur();
      }, 0);
    }
    function closeTableEditModal() { qs('edit-table-modal').classList.remove('active'); }

    function parseDate(dateStr) {
      if (!dateStr) return '';
      const parts = String(dateStr).split('.');
      if (parts.length === 3) {
        return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
      }
      return dateStr;
    }
    function formatToDDMMYYYY(dateStr) {
      if (!dateStr) return '';
      const parts = String(dateStr).split('-');
      if (parts.length === 3) {
        return `${parts[2].padStart(2,'0')}.${parts[1].padStart(2,'0')}.${parts[0]}`;
      }
      return dateStr;
    }
    function normalizeRoom(location) {
      if (!location) return '';
      const upper = String(location).toUpperCase();
      if (upper.includes('ALJAZ') || upper.includes('ALJA≈Ω')) return 'ALJAZ';
      if (upper.includes('JULIJA')) return 'JULIJA';
      if (upper.includes('ANA')) return 'ANA';
      return '';
    }
    function normalizeTable(location) {
      if (!location) return 'Pri peƒçi';
      const lower = String(location).toLowerCase();
      if (lower.includes('peƒç')) return 'Pri peƒçi';
      if (lower.includes('vrt')) return 'Pri vrtu';
      return 'Pri peƒçi';
    }

    qs('room-edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = qs('room-edit-hidden-id').value;
      const payload = {
        status: qs('room-edit-status').value,
        date: formatToDDMMYYYY(qs('room-edit-date').value),
        nights: parseInt(qs('room-edit-nights').value || '1'),
        location: qs('room-edit-location').value,
        people: parseInt(qs('room-edit-people').value || '1'),
        kids: qs('room-edit-kids').value,
        kids_small: qs('room-edit-kids-ages').value,
        name: qs('room-edit-name').value,
        email: qs('room-edit-email').value,
        phone: qs('room-edit-phone').value,
        note: qs('room-edit-note').value,
        admin_notes: qs('room-edit-admin-notes').value,
      };
      const res = await fetch(`${API_BASE}/reservations/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        toast('Napaka pri shranjevanju sobe.', 'error');
        return;
      }
      toast('Rezervacija sobe shranjena.', 'success');
      closeRoomEditModal();
      loadAll();
    });

    qs('table-edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = qs('table-edit-hidden-id').value;
      const payload = {
        status: qs('table-edit-status').value,
        date: formatToDDMMYYYY(qs('table-edit-date').value),
        time: qs('table-edit-time').value,
        location: qs('table-edit-location').value,
        people: parseInt(qs('table-edit-people').value || '1'),
        kids: qs('table-edit-kids').value,
        kids_small: qs('table-edit-kids-ages').value,
        event_type: qs('table-edit-event-type').value,
        name: qs('table-edit-name').value,
        email: qs('table-edit-email').value,
        phone: qs('table-edit-phone').value,
        special_needs: qs('table-edit-special-needs').value,
        admin_notes: qs('table-edit-admin-notes').value,
      };
      const res = await fetch(`${API_BASE}/reservations/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        toast('Napaka pri shranjevanju mize.', 'error');
        return;
      }
      toast('Rezervacija mize shranjena.', 'success');
      closeTableEditModal();
      loadAll();
    });

    qs('new-room-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        date: formatToDDMMYYYY(qs('new-room-date').value),
        nights: parseInt(qs('new-room-nights').value || '1'),
        location: qs('new-room-location').value,
        people: parseInt(qs('new-room-people').value || '1'),
        kids: qs('new-room-kids').value,
        kids_small: qs('new-room-kids-ages').value,
        name: qs('new-room-name').value,
        email: qs('new-room-email').value,
        phone: qs('new-room-phone').value,
        note: qs('new-room-note').value,
        status: 'confirmed',
        reservation_type: 'room',
        source: 'admin',
      };
      const res = await fetch(`${API_BASE}/reservations`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) {
        toast(data.detail || 'Napaka pri shranjevanju.', 'error');
        return;
      }
      if (data.warning) {
        toast(data.warning, 'warning');
      } else {
        toast('Rezervacija sobe dodana.', 'success');
      }
      closeNewRoom();
      loadAll();
    });

    qs('new-table-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        date: formatToDDMMYYYY(qs('new-table-date').value),
        time: qs('new-table-time').value,
        location: qs('new-table-location').value,
        people: parseInt(qs('new-table-people').value || '1'),
        kids: qs('new-table-kids').value,
        kids_small: qs('new-table-kids-ages').value,
        event_type: qs('new-table-event-type').value,
        name: qs('new-table-name').value,
        email: qs('new-table-email').value,
        phone: qs('new-table-phone').value,
        special_needs: qs('new-table-special-needs').value,
        status: 'confirmed',
        reservation_type: 'table',
        source: 'admin',
      };
      const res = await fetch(`${API_BASE}/reservations`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) {
        toast(data.detail || 'Napaka pri shranjevanju.', 'error');
        return;
      }
      if (data.warning) {
        toast(data.warning, 'warning');
      } else {
        toast('Rezervacija mize dodana.', 'success');
      }
      clearNewTableForm();
      closeNewTable();
      loadAll();
    });

    async function exportCsv() {
      const query = buildQuery();
      const res = await fetch(`${API_BASE}/export?${query}`);
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reservations.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
