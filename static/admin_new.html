<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kmetija Pod Goro - Admin (nova postavitev)</title>
  <style>
    :root {
      --bg: #f7f3ee;
      --card: #fff;
      --ink: #2b241a;
      --muted: #7a6a55;
      --brand: #7b5e3b;
      --brand-2: #c49b6d;
      --border: #e6dfd6;
      --shadow: 0 10px 30px rgba(54, 38, 20, 0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Trebuchet MS", "Segoe UI", Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .app {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
      padding: 16px;
    }
    .topbar {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 18px;
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .title {
      font-weight: 800;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      background: #f3ede4;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 700;
      font-size: 12px;
      color: var(--muted);
    }
    .main {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      min-height: 0;
    }
    .panel {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 12px;
      min-height: 0;
    }
    .filters {
      display: grid;
      gap: 8px;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .seg {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
    }
    .seg.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }
    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
    }
    .list {
      overflow: auto;
      border-top: 1px dashed var(--border);
      padding-top: 8px;
      display: grid;
      gap: 8px;
      min-height: 0;
    }
    .item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display: grid;
      gap: 6px;
      cursor: pointer;
      background: #fff;
      transition: box-shadow 0.1s ease, border-color 0.1s ease;
    }
    .item.active {
      border-color: var(--brand);
      box-shadow: 0 6px 16px rgba(123, 94, 59, 0.15);
    }
    .item .line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
    }
    .badge {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      background: #efe6d9;
      color: #6b4b2b;
    }
    .status {
      font-weight: 800;
      text-transform: uppercase;
      font-size: 11px;
    }
    .status.pending { color: #b45309; }
    .status.processing { color: #92400e; }
    .status.confirmed { color: #166534; }
    .status.rejected { color: #991b1b; }

    .detail {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 0;
      gap: 10px;
    }
    .detail-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .detail-title {
      font-weight: 800;
      font-size: 18px;
    }
    .btn {
      border: none;
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--brand);
      color: #fff;
      box-shadow: 0 8px 20px rgba(123,94,59,0.2);
    }
    .btn.secondary { background: #f1ede5; color: #4b3a28; box-shadow: none; }
    .btn.ghost { background: #fff; color: #4b3a28; border: 1px solid var(--border); box-shadow: none; }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .field { display: grid; gap: 6px; }
    label { font-weight: 700; font-size: 12px; color: var(--muted); }
    textarea.input { min-height: 90px; }

    .comms {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      min-height: 0;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #faf8f3;
    }
    .thread {
      overflow: auto;
      max-height: 320px;
      display: grid;
      gap: 8px;
      font-size: 13px;
    }
    .msg {
      border-bottom: 1px dashed var(--border);
      padding-bottom: 6px;
    }
    .msg:last-child { border-bottom: 0; }
    .meta { color: var(--muted); font-size: 12px; }

    .sticky-actions {
      position: sticky;
      bottom: 0;
      background: var(--card);
      padding-top: 10px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .empty {
      padding: 24px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      color: var(--muted);
      text-align: center;
    }

    @media (max-width: 980px) {
      .main { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .thread { max-height: 240px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">üè† Kmetija Pod Goro - Admin (osnovni)</div>
      <div class="stats" id="stats"></div>
      <div id="imap-indicator" class="chip">IMAP: ...</div>
    </div>

    <div class="main">
      <div class="panel">
        <div class="filters">
          <input id="search" class="input" placeholder="Isci (ime, email, telefon, ID)" />
          <div class="row" id="status-tabs"></div>
          <div class="row" id="type-tabs"></div>
        </div>
        <div class="list" id="list"></div>
      </div>

      <div class="panel detail">
        <div class="detail-head">
          <div class="detail-title" id="detail-title">Izberi rezervacijo</div>
          <div class="row">
            <button class="btn ghost" id="btn-confirm">‚úÖ Potrdi</button>
            <button class="btn ghost" id="btn-reject">‚ùå Zavrni</button>
            <button class="btn" id="btn-reply">‚úâ Odgovori</button>
          </div>
        </div>

        <div class="detail-body" id="detail-body">
          <div class="empty">Izberi rezervacijo z leve strani.</div>
        </div>

        <div class="sticky-actions">
          <button class="btn secondary" id="btn-refresh">‚ü≥ Osvezi</button>
          <button class="btn" id="btn-save">üíæ Shrani</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    const qs = (id) => document.getElementById(id);
    const state = {
      status: 'pending',
      type: '',
      reservations: [],
      current: null,
      messages: [],
    };

    const STATUS_TABS = [
      { id: 'pending', label: 'Caka' },
      { id: 'processing', label: 'V obdelavi' },
      { id: 'confirmed', label: 'Potrjeno' },
      { id: 'rejected', label: 'Zavrnjeno' },
      { id: '', label: 'Vsi' },
    ];
    const TYPE_TABS = [
      { id: 'room', label: 'Sobe' },
      { id: 'table', label: 'Mize' },
      { id: '', label: 'Vse' },
    ];

    function buildTabs(container, items, currentKey, onChange) {
      container.innerHTML = items.map(i => `<button class="seg ${state[currentKey] === i.id ? 'active' : ''}" data-id="${i.id}">${i.label}</button>`).join('');
      container.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          state[currentKey] = btn.dataset.id;
          buildTabs(container, items, currentKey, onChange);
          onChange();
        });
      });
    }

    function formatDate(d) {
      if (!d) return '';
      const parts = String(d).split('.');
      if (parts.length === 3) return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
      return d;
    }
    function formatToDDMMYYYY(iso) {
      if (!iso) return '';
      const parts = iso.split('-');
      if (parts.length !== 3) return iso;
      return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }
    function formatTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return String(ts);
      return d.toLocaleString('sl-SI', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/reservations?limit=1`);
        const data = await res.json();
        const s = data.stats || {};
        qs('stats').innerHTML = [
          `Danas: ${s.today ?? 0}`,
          `Caka: ${s.pending ?? 0}`,
          `V obdelavi: ${s.processing ?? 0}`,
          `Potrjeno: ${s.confirmed ?? 0}`,
        ].map(t => `<span class="chip">${t}</span>`).join('');
      } catch (e) {}
    }

    async function loadImapStatus() {
      try {
        const res = await fetch(`${API_BASE}/imap_status`);
        if (!res.ok) return;
        const data = await res.json().catch(() => ({}));
        const last = data.last_poll_at ? `IMAP: ${data.last_poll_at}` : 'IMAP: -';
        const err = data.last_error ? ` ‚Ä¢ napaka: ${data.last_error}` : '';
        qs('imap-indicator').textContent = `${last}${err}`;
      } catch (e) {}
    }

    async function loadReservations() {
      const params = new URLSearchParams();
      params.set('limit', '200');
      if (state.status) params.set('status', state.status);
      if (state.type) params.set('type', state.type);
      const res = await fetch(`${API_BASE}/reservations?${params.toString()}`);
      const data = await res.json();
      state.reservations = data.reservations || [];
      renderList();
    }

    function renderList() {
      const q = (qs('search').value || '').toLowerCase().trim();
      const list = qs('list');
      const filtered = state.reservations.filter(r => {
        if (!q) return true;
        const hay = [r.id, r.name, r.email, r.phone, r.date].join(' ').toLowerCase();
        return hay.includes(q);
      });
      list.innerHTML = filtered.map(r => {
        const status = r.status || 'pending';
        const active = state.current?.id === r.id ? 'active' : '';
        const typeLabel = r.reservation_type === 'table' ? 'MIZA' : 'SOBA';
        return `
          <div class="item ${active}" data-id="${r.id}">
            <div class="line"><strong>#${r.id} ${r.name || 'Neznano'}</strong><span class="badge">${typeLabel}</span></div>
            <div class="line"><span>${r.date || '-'}</span><span>${r.people || 0} oseb</span></div>
            <div class="line"><span class="status ${status}">${status}</span><span>${r.email || '-'}</span></div>
          </div>
        `;
      }).join('') || '<div class="empty">Ni zadetkov.</div>';

      list.querySelectorAll('.item').forEach(el => {
        el.addEventListener('click', () => {
          const id = parseInt(el.dataset.id, 10);
          const r = state.reservations.find(x => x.id === id);
          if (r) selectReservation(r);
        });
      });
    }

    function renderDetail(r) {
      if (!r) {
        qs('detail-body').innerHTML = '<div class="empty">Izberi rezervacijo z leve strani.</div>';
        qs('detail-title').textContent = 'Izberi rezervacijo';
        return;
      }
      qs('detail-title').textContent = `Rezervacija #${r.id}`;
      const isTable = r.reservation_type === 'table';
      qs('detail-body').innerHTML = `
        <div class="grid">
          <div class="field">
            <label>Status</label>
            <select class="input" id="f-status">
              <option value="pending">Caka</option>
              <option value="processing">V obdelavi</option>
              <option value="confirmed">Potrjeno</option>
              <option value="rejected">Zavrnjeno</option>
            </select>
          </div>
          <div class="field">
            <label>Datum</label>
            <input class="input" type="date" id="f-date" />
          </div>
          <div class="field" style="display:${isTable ? 'none' : 'grid'}">
            <label>Nocitve</label>
            <input class="input" type="number" id="f-nights" min="1" />
          </div>
          <div class="field" style="display:${isTable ? 'grid' : 'none'}">
            <label>Ura prihoda</label>
            <input class="input" type="time" id="f-time" />
          </div>
          <div class="field">
            <label>Lokacija</label>
            <input class="input" type="text" id="f-location" />
          </div>
          <div class="field">
            <label>St. oseb</label>
            <input class="input" type="number" id="f-people" min="1" />
          </div>
          <div class="field">
            <label>Otroci</label>
            <input class="input" type="text" id="f-kids" />
          </div>
          <div class="field">
            <label>Ime</label>
            <input class="input" type="text" id="f-name" />
          </div>
          <div class="field">
            <label>Email</label>
            <input class="input" type="email" id="f-email" />
          </div>
          <div class="field">
            <label>Telefon</label>
            <input class="input" type="text" id="f-phone" />
          </div>
        </div>
        <div class="field">
          <label>Opombe gosta</label>
          <textarea class="input" id="f-note"></textarea>
        </div>
        <div class="field">
          <label>Admin opombe</label>
          <textarea class="input" id="f-admin"></textarea>
        </div>
        <div class="comms">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <strong>Komunikacija</strong>
            <button class="btn ghost" id="btn-refresh-msg">‚ü≥ Osvezi</button>
          </div>
          <div class="thread" id="thread"></div>
          <div class="field">
            <label>Zadeva</label>
            <input class="input" id="reply-subject" />
          </div>
          <div class="field">
            <label>Sporocilo</label>
            <textarea class="input" id="reply-body" placeholder="Vnesi odgovor..."></textarea>
          </div>
        </div>
      `;

      qs('f-status').value = r.status || 'pending';
      qs('f-date').value = formatDate(r.date);
      if (!isTable) qs('f-nights').value = r.nights || 1;
      if (isTable) qs('f-time').value = r.time || '12:00';
      qs('f-location').value = r.location || '';
      qs('f-people').value = r.people || 1;
      qs('f-kids').value = r.kids || '';
      qs('f-name').value = r.name || '';
      qs('f-email').value = r.email || '';
      qs('f-phone').value = r.phone || '';
      qs('f-note').value = r.note || '';
      qs('f-admin').value = r.admin_notes || '';

      qs('reply-subject').value = `Rezervacija #${r.id} - Odgovor`;
      qs('reply-body').value = '';

      qs('btn-refresh-msg').addEventListener('click', () => loadMessages(r.id));
      loadMessages(r.id);
    }

    function buildConversationEntries(reservation, messages) {
      const entries = [];
      if (reservation?.created_at) entries.push({ ts: reservation.created_at, label: 'Rezervacija ustvarjena', kind: 'event' });
      if (reservation?.confirmed_at) entries.push({ ts: reservation.confirmed_at, label: 'Rezervacija potrjena', kind: 'event' });
      (messages || []).forEach(m => entries.push({ ts: m.created_at || '', subject: m.subject || '', body: m.body || '', direction: (m.direction || '').toLowerCase(), kind: 'message' }));
      return entries.sort((a,b) => String(a.ts).localeCompare(String(b.ts)));
    }

    async function loadMessages(resId) {
      const res = await fetch(`${API_BASE}/reservations/${resId}/messages`);
      const data = await res.json().catch(() => ({}));
      const msgs = data.messages || [];
      state.messages = msgs;
      const entries = buildConversationEntries(state.current, msgs);
      const thread = qs('thread');
      if (!thread) return;
      if (!entries.length) {
        thread.innerHTML = '<div class="empty">Ni sporocil.</div>';
        return;
      }
      thread.innerHTML = entries.map(e => {
        const label = e.kind === 'event' ? 'Sistem' : (e.direction === 'inbound' ? 'Gost' : 'Moj odgovor');
        const title = e.kind === 'event' ? e.label : (e.subject || '');
        const body = e.kind === 'event' ? '' : (e.body || '');
        return `
          <div class="msg">
            <div class="meta">${label} ‚Ä¢ ${formatTimestamp(e.ts || '')}</div>
            <div><strong>${title || ''}</strong></div>
            ${body ? `<div>${body}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function selectReservation(r) {
      state.current = r;
      renderList();
      renderDetail(r);
    }

    async function saveCurrent() {
      const r = state.current;
      if (!r) return;
      const payload = {
        status: qs('f-status').value,
        date: formatToDDMMYYYY(qs('f-date').value),
        nights: qs('f-nights') ? parseInt(qs('f-nights').value || '1') : undefined,
        time: qs('f-time') ? qs('f-time').value : undefined,
        location: qs('f-location').value,
        people: parseInt(qs('f-people').value || '1'),
        kids: qs('f-kids').value,
        admin_notes: qs('f-admin').value,
        name: qs('f-name').value,
        email: qs('f-email').value,
        phone: qs('f-phone').value,
        note: qs('f-note').value,
      };
      const res = await fetch(`${API_BASE}/reservations/${r.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        await loadReservations();
        const updated = state.reservations.find(x => x.id === r.id);
        if (updated) selectReservation(updated);
      } else {
        alert('Napaka pri shranjevanju.');
      }
    }

    async function replyCurrent() {
      const r = state.current;
      if (!r) return;
      const payload = {
        reservation_id: r.id,
        email: r.email,
        subject: qs('reply-subject').value,
        body: qs('reply-body').value,
        set_processing: false,
      };
      const res = await fetch(`${API_BASE}/send-message`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        qs('reply-body').value = '';
        loadMessages(r.id);
      } else {
        alert('Napaka pri posiljanju.');
      }
    }

    async function confirmCurrent() {
      const r = state.current;
      if (!r) return;
      const res = await fetch(`${API_BASE}/reservations/${r.id}/confirm`, { method: 'POST' });
      if (res.ok) {
        await loadReservations();
        const updated = state.reservations.find(x => x.id === r.id);
        if (updated) selectReservation(updated);
      }
    }

    async function rejectCurrent() {
      const r = state.current;
      if (!r) return;
      const res = await fetch(`${API_BASE}/reservations/${r.id}/reject`, { method: 'POST' });
      if (res.ok) {
        await loadReservations();
        const updated = state.reservations.find(x => x.id === r.id);
        if (updated) selectReservation(updated);
      }
    }

    function bindActions() {
      qs('btn-save').addEventListener('click', saveCurrent);
      qs('btn-reply').addEventListener('click', replyCurrent);
      qs('btn-confirm').addEventListener('click', confirmCurrent);
      qs('btn-reject').addEventListener('click', rejectCurrent);
      qs('btn-refresh').addEventListener('click', () => { loadReservations(); loadStats(); loadImapStatus(); });
      qs('search').addEventListener('input', renderList);
    }

    function init() {
      buildTabs(qs('status-tabs'), STATUS_TABS, 'status', loadReservations);
      buildTabs(qs('type-tabs'), TYPE_TABS, 'type', loadReservations);
      bindActions();
      loadStats();
      loadImapStatus();
      loadReservations();
      setInterval(loadImapStatus, 60000);
    }

    init();
  </script>
</body>
</html>
